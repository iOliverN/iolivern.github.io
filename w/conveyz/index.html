<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ezpkg.io/conveyz: Understanding the Implementation of FConvey | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="ezpkg.io/conveyz: Understanding the Implementation of FConvey"><meta property="og:description" content="The FConvey function is a standout feature of ezpkg.io/conveyz, designed to simplify focused testing in Go. Unlike the original smartystreets/goconvey framework, which requires developers to set FocusConvey at every nested block level, FConvey is smarter. It ensures that focusing on a single block propagates to all relevant nested and parent blocks, streamlining the debugging process.
In this article, we dive deep into the implementation of FConvey, why the original FocusConvey does require manual setting at every level, and how FConvey solves the problem."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/conveyz/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2024-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-20T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="ezpkg.io/conveyz: Understanding the Implementation of FConvey"><meta name="twitter:description" content="The FConvey function is a standout feature of ezpkg.io/conveyz, designed to simplify focused testing in Go. Unlike the original smartystreets/goconvey framework, which requires developers to set FocusConvey at every nested block level, FConvey is smarter. It ensures that focusing on a single block propagates to all relevant nested and parent blocks, streamlining the debugging process.
In this article, we dive deep into the implementation of FConvey, why the original FocusConvey does require manual setting at every level, and how FConvey solves the problem."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/conveyz/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script src="/script.js"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">ezpkg.io/conveyz: Understanding the Implementation of FConvey</h1><div class="meta"><div class="postdate"><time datetime="2024-12-20 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-12-20</time></div><div class="article-tag">&nbsp;·&nbsp; <a class="tag-link" href="/w/#go" rel="tag">go</a></div>&nbsp;·&nbsp;&nbsp;<a href="#subscribe">subscribe to my posts</a></div></header><div class="content" itemprop="articleBody"><p><em>The <a href="https://pkg.go.dev/ezpkg.io/conveyz#FConvey"><code>FConvey</code></a> function is a standout feature of <a href="https://ezpkg/conveyz">ezpkg.io/conveyz</a>, designed to simplify focused testing in Go. Unlike the original <a href="https://github.com/smartystreets/goconvey">smartystreets/goconvey</a> framework, which requires developers to set <code>FocusConvey</code> at every nested block level, <code>FConvey</code> is smarter. It ensures that focusing on a single block propagates to all relevant nested and parent blocks, streamlining the debugging process.</em></p><p><em>In this article, we dive deep into the implementation of <code>FConvey</code>, why the original <code>FocusConvey</code> does require manual setting at every level, and how <code>FConvey</code> solves the problem.</em></p><h2 id="the-motivation-behind-ezpkgioconveyzhttpsezpkgioconveyz">The motivation behind <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a></h2><p>Before we dive into the implementation details, let&rsquo;s first understand the motivation behind the creation of <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a>.</p><h3 id="ginkgo-and-gomega-are-great-but-verbose">Ginkgo and Gomega are great, but verbose</h3><p>At work, we use <a href="https://github.com/onsi/gomega">gomega</a> and <a href="https://github.com/onsi/ginkgo">ginkgo</a> for writing behaviour tests. They are great, but sometimes too verbose. We have to write a lot of boilerplate code to set up the test environment, and it&rsquo;s hard to focus on the test itself.</p><ul><li>Each package has a <code>suite_test.go</code> file to set up the test environment, with <code>RegisterFailHandler(Fail)</code> and <code>RunSpecs()</code>.</li><li>Each file starts with <code>Describe</code> block then <code>var</code> block, then <code>Context</code> blocks, then more <code>var</code> blocks, then more <code>Context</code> blocks, with <code>BeforeEach</code> and <code>AfterEach</code> blocks inside, then end up with a lot of <code>It</code> blocks at the leaf.</li><li>Lists of variables are declared at the beginning of the <code>Describe</code> and <code>Context</code> blocks, then initialized in <code>BeforeEach</code> blocks, before being used in <code>It</code> blocks, or <code>JustBeforeEach</code> blocks.</li><li>And even <code>JustBeforeEach</code> blocks to keep the execution logic separated.</li><li>So the execution is outer blocks to inner blocks: <code>Describe</code> then <code>BeforeEach</code> then <code>Context</code> then <code>BeforeEach</code> then <code>It</code>.<br>Oh, no! It needs to jump to <code>JustBeforeEach</code> before <code>It</code>. Finally, <code>AfterEach</code> at the last.</li><li>And we have to repeat the same setup for each test file.</li></ul><p>Well, you got it!</p><p>An example of <code>profile_suite_test.go</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile_test</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="p">.</span> <span class="s">&#34;github.com/onsi/ginkgo/v2&#34;</span>
    <span class="p">.</span> <span class="s">&#34;github.com/onsi/gomega&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestProfile</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">RegisterFailHandler</span><span class="p">(</span><span class="nx">Fail</span><span class="p">)</span>
    <span class="nf">RunSpecs</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;Profile Suite&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>and <code>user_test.go</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">user_test</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="p">.</span> <span class="s">&#34;github.com/onsi/ginkgo/v2&#34;</span>
    <span class="p">.</span> <span class="s">&#34;github.com/onsi/gomega&#34;</span>
    <span class="s">&#34;go.uber.org/mock/gomock&#34;</span>

    <span class="nx">profilepb</span> <span class="s">&#34;connectly.ai/go/pb/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile/mocks&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">Describe</span><span class="p">(</span><span class="s">&#34;UserService&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="p">(</span>
        <span class="nx">ctx</span>      <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="nx">ctrl</span>     <span class="o">*</span><span class="nx">gomock</span><span class="p">.</span><span class="nx">Controller</span>
        <span class="nx">mockRepo</span> <span class="o">*</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">MockProfileRepository</span>
        <span class="nx">service</span>  <span class="nx">profilepb</span><span class="p">.</span><span class="nx">UserServiceServer</span>
    <span class="p">)</span>
    <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
        <span class="nx">ctrl</span> <span class="p">=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nf">GinkgoT</span><span class="p">())</span>
        <span class="nx">mockRepo</span> <span class="p">=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewMockProfileRepository</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
        <span class="nx">service</span> <span class="p">=</span> <span class="nx">profile</span><span class="p">.</span><span class="nf">NewUserService</span><span class="p">(</span><span class="nx">mockRepo</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nf">AfterEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ctrl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="nf">Describe</span><span class="p">(</span><span class="s">&#34;SignUp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="p">(</span>
            <span class="nx">req</span> <span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">SignUpRequest</span>
            <span class="nx">res</span> <span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">SignUpResponse</span>
            <span class="nx">err</span> <span class="kt">error</span>
        <span class="p">)</span>
        <span class="nf">JustBeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">SignUpRequest</span><span class="p">{</span>
                <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
                <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;password123&#34;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;valid username &amp; password&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span>
                    <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">).</span>
                    <span class="nf">Return</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should success&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">UserID</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">BeEmpty</span><span class="p">())</span>
            <span class="p">})</span>
        <span class="p">})</span>
        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;password123&#34;</span>
            <span class="p">})</span>
            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()).</span><span class="nf">To</span><span class="p">(</span><span class="nf">ContainSubstring</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">))</span>
            <span class="p">})</span>
        <span class="p">})</span>
        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;invalid password: too short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;****&#34;</span>
            <span class="p">})</span>
            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()).</span><span class="nf">To</span><span class="p">(</span><span class="nf">ContainSubstring</span><span class="p">(</span><span class="s">&#34;password too short&#34;</span><span class="p">))</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div><h3 id="convey-focus-on-the-test-not-the-setup">Convey: Focus on the test, not the setup</h3><p>Compare the above code with the following from <a href="https://github.com/smartystreets/goconvey">smartystreets/goconvey</a>. It&rsquo;s much simpler and easier to focus on the test itself.</p><ul><li>No need to set up the test environment in a separate file.</li><li>You only need to use <code>Convey</code> and <code>So</code> to write the test.</li><li>The execution is straightforward: <code>Convey</code> then <code>Convey</code> then <code>Convey</code> then <code>defer()</code>.</li><li>Each run, it executes from the root block to each leaf block:<br><code>UserService → SignUp → valid username &amp; password → should success → defer()</code><br><code>UserService → SignUp → invalid username → should error → defer()</code><br></li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile_test</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="p">.</span> <span class="s">&#34;github.com/smartystreets/goconvey/convey&#34;</span>
    <span class="s">&#34;go.uber.org/mock/gomock&#34;</span>

    <span class="nx">profilepb</span> <span class="s">&#34;connectly.ai/go/pb/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile/mocks&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestUserSignUp</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;UserService&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ctx</span>      <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="nx">ctrl</span>     <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
        <span class="nx">mockRepo</span> <span class="o">:=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewMockProfileRepository</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
        <span class="nx">service</span>  <span class="o">:=</span> <span class="nx">profile</span><span class="p">.</span><span class="nf">NewSignUpService</span><span class="p">(</span><span class="nx">mockRepo</span><span class="p">)</span>
        <span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>

        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;SignUp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">SignUpRequest</span><span class="p">{</span>
                <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
                <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;password123&#34;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;valid username &amp; password&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span>
                    <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">).</span>
                    <span class="nf">Return</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span>
                
                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should success&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ShouldBeNil</span><span class="p">)</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">UserID</span><span class="p">,</span> <span class="nx">ShouldNotBeEmpty</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="p">=</span> <span class="s">&#34;admin@&#34;</span>
                
                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ShouldNotBeNil</span><span class="p">)</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="nx">ShouldContainSubstring</span><span class="p">,</span> <span class="s">&#34;invalid username&#34;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid password: too short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;****&#34;</span>
                
                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ShouldNotBeNil</span><span class="p">)</span>
                    <span class="nf">So</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="nx">ShouldContainSubstring</span><span class="p">,</span> <span class="s">&#34;invalid password&#34;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><h3 id="problems-incompatible-assertions-and-repeated-focusconvey">Problems: Incompatible assertions and repeated <code>FocusConvey</code></h3><p>While the code looks cleaner, there are still some problems:</p><ul><li>With ginkgo, you can focus on a single block by setting <code>FIt</code> or <code>FContext</code>. Basically, add a single <code>F</code> and it will only run that block (and children), skipping others.<br>But in goconvey, you have to set <code>FocusConvey</code> at every level. It&rsquo;s not smart enough to propagate the focus to all relevant blocks.</li><li>And the assertions are not compatible. You have to change <code>Ω</code> to <code>So</code>, <code>To</code> to <code>Should</code>, <code>ToNot</code> to <code>ShouldNot</code>, <code>ToNotBeEmpty</code> to <code>ShouldNotBeEmpty</code>, <code>To(HaveOccurred())</code> to <code>ShouldNotBeNil</code>, <code>To(ContainSubstring(&quot;...&quot;))</code> to <code>ShouldContainSubstring(&quot;...&quot;)</code>, and so on.<br>We don&rsquo;t want to maintain two sets of assertions, and it&rsquo;s hard to convince the team to switch to goconvey or even doing the rewrite.</li></ul><h2 id="meet-ezpkgioconveyz">Meet ezpkg.io/conveyz</h2><p>So, I decided to create a new package, <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a>, to solve the above problems. It&rsquo;s a wrapper around goconvey, with the following features:</p><ul><li><code>Ω</code> to replace <code>So</code> and <code>To</code> in goconvey, so you can use the same assertions as gomega.</li><li><code>FConvey</code> to focus on a single block and propagate to all relevant blocks while skipping others.</li></ul><p>The above code can be rewritten as:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile_test</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="p">.</span> <span class="s">&#34;ezpkg.io/conveyz&#34;</span>
    <span class="s">&#34;go.uber.org/mock/gomock&#34;</span>

    <span class="nx">profilepb</span> <span class="s">&#34;connectly.ai/go/pb/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile&#34;</span>
    <span class="s">&#34;connectly.ai/go/services/profile/mocks&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">TestUserSignUp</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;UserService&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="nx">ctrl</span> <span class="o">:=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
        <span class="nx">mockRepo</span> <span class="o">:=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewMockProfileRepository</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
        <span class="nx">service</span> <span class="o">:=</span> <span class="nx">profile</span><span class="p">.</span><span class="nf">NewSignUpService</span><span class="p">(</span><span class="nx">mockRepo</span><span class="p">)</span>
        <span class="k">defer</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>

        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;SignUp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">SignUpRequest</span><span class="p">{</span>
                <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
                <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;password123&#34;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;valid username &amp; password&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span>
                    <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">).</span>
                    <span class="nf">Return</span><span class="p">(</span> <span class="cm">/*...*/</span> <span class="p">)</span>

                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should success&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nx">HaveOccurred</span><span class="p">)</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">UserID</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nx">BeEmpty</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="p">=</span> <span class="s">&#34;admin@&#34;</span>
                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()).</span><span class="nf">To</span><span class="p">(</span><span class="nx">ContainSubstring</span><span class="p">,</span> <span class="s">&#34;invalid username&#34;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid password: too short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;****&#34;</span>
                <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">SignUp</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>

                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should error&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()).</span><span class="nf">To</span><span class="p">(</span><span class="nf">ContainSubstring</span><span class="p">(</span><span class="s">&#34;password too short&#34;</span><span class="p">))</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><h2 id="solution-make-gomega-ω-work-with-goconvey">Solution: Make &ldquo;gomega&rdquo; <code>Ω</code> work with &ldquo;goconvey&rdquo;</h2><p>We can make <code>Ω</code> work with goconvey by <a href="https://github.com/ezpkg/ezpkg/blob/6f91299c405090f3a7289b6e8f591796a43d626e/conveyz/conveyz.go#L81-L84">creating an adapter</a> that implements <a href="https://pkg.go.dev/github.com/onsi/gomega#Assertion">gomega.Assertion</a>:</p><ul><li>The adapter will call <code>convey.So()</code> with the actual value and the matcher.</li><li>It returns empty string if the matcher passes, or the error message if the matcher fails.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">conveyz</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/onsi/gomega&#34;</span>
    <span class="nx">gomegatypes</span> <span class="s">&#34;github.com/onsi/gomega/types&#34;</span>
    <span class="s">&#34;github.com/smartystreets/goconvey/convey&#34;</span>
<span class="p">)</span>

<span class="c1">// Ω is a reimplemented version of gomega.Expect to call goconvey.So under the hood.
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">Ω</span><span class="p">(</span><span class="nx">actual</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">extra</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="nx">gomega</span><span class="p">.</span><span class="nx">Assertion</span> <span class="p">{</span>
    <span class="nx">assertion</span> <span class="o">:=</span> <span class="nx">gomega</span><span class="p">.</span><span class="nf">Expect</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="nx">extra</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">gomegaAssertion</span><span class="p">{</span><span class="nx">actual</span><span class="p">:</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">assertion</span><span class="p">:</span> <span class="nx">assertion</span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">gomegaAssertion</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">actual</span>    <span class="nx">any</span>
    <span class="nx">offset</span>    <span class="kt">int</span>
    <span class="nx">assertion</span> <span class="nx">gomega</span><span class="p">.</span><span class="nx">Assertion</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">gomegaAssertion</span><span class="p">)</span> <span class="nf">To</span><span class="p">(</span><span class="nx">matcher</span> <span class="nx">gomegatypes</span><span class="p">.</span><span class="nx">GomegaMatcher</span><span class="p">,</span> <span class="nx">optionalDescription</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">convey</span><span class="p">.</span><span class="nf">So</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
        <span class="nx">success</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">matcher</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">stack</span> <span class="o">:=</span> <span class="nx">stacktracez</span><span class="p">.</span><span class="nf">StackTraceSkip</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">formatMsg</span><span class="p">(</span><span class="nx">optionalDescription</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="s">&#34;%vUNEXPECTED: %v%v&#34;</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">success</span> <span class="p">{</span>
            <span class="nx">stack</span> <span class="o">:=</span> <span class="nx">stacktracez</span><span class="p">.</span><span class="nf">StackTraceSkip</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">matcher</span><span class="p">.</span><span class="nf">FailureMessage</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">formatMsg</span><span class="p">(</span><span class="nx">optionalDescription</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">gomegaAssertion</span><span class="p">)</span> <span class="nf">ToNot</span><span class="p">(</span><span class="nx">matcher</span> <span class="nx">gomegatypes</span><span class="p">.</span><span class="nx">GomegaMatcher</span><span class="p">,</span> <span class="nx">optionalDescription</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">convey</span><span class="p">.</span><span class="nf">So</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
        <span class="nx">success</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">matcher</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">stack</span> <span class="o">:=</span> <span class="nx">stacktracez</span><span class="p">.</span><span class="nf">StackTraceSkip</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">formatMsg</span><span class="p">(</span><span class="nx">optionalDescription</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="s">&#34;%vUNEXPECTED: %v%v&#34;</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Red</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Yellow</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">success</span> <span class="p">{</span>
            <span class="nx">stack</span> <span class="o">:=</span> <span class="nx">stacktracez</span><span class="p">.</span><span class="nf">StackTraceSkip</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="nx">msg</span> <span class="o">:=</span> <span class="nx">matcher</span><span class="p">.</span><span class="nf">NegatedFailureMessage</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">actual</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">formatMsg</span><span class="p">(</span><span class="nx">optionalDescription</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div><p>When failure, the output will look like this, with a nice error message and a focused stacktrace:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Failures:

  * /Users/i/conn/go/services/profile/user_test.go
  Line 160:
  Expected
      &lt;bool&gt;: true
  to be false

  go/sdks/errors/api/error_test.go:160 · api.TestUser.func1.2.1.1
  go/sdks/errors/api/error_test.go:155 · api.TestUser.func1.2.1
  go/sdks/errors/api/error_test.go:94 · api.TestUser.func1.2
  go/sdks/errors/api/error_test.go:63 · api.TestUser.func1
  go/sdks/errors/api/error_test.go:36 · api.TestUser


120 total assertions

--- FAIL: TestUser (0.01s)
</code></pre></div><p>And to make it easier for our engineers, we can <a href="https://github.com/ezpkg/ezpkg/blob/6f91299c405090f3a7289b6e8f591796a43d626e/conveyz/gomega.go#L18">re-export</a> all the assertions from gomega:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">BeNil</span><span class="p">()</span> <span class="nx">types</span><span class="p">.</span><span class="nx">GomegaMatcher</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gomega</span><span class="p">.</span><span class="nf">BeNil</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BeTrue</span><span class="p">()</span> <span class="nx">types</span><span class="p">.</span><span class="nx">GomegaMatcher</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gomega</span><span class="p">.</span><span class="nf">BeTrue</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">BeFalse</span><span class="p">()</span> <span class="nx">types</span><span class="p">.</span><span class="nx">GomegaMatcher</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">gomega</span><span class="p">.</span><span class="nf">BeFalse</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p>So to migrate tests from goconvey to ezpkg.io/conveyz, you don&rsquo;t need to change the assertions, just do some cleanup:</p><ul><li>Replace the gomega/ginkgo imports with <code>. &quot;ezpkg.io/conveyz&quot;</code>.</li><li>Replace all <code>Describe</code>|<code>Context</code>|<code>It</code> with <code>Convey</code>.</li><li>Remove <code>BeforeEach</code> and merge it with the <code>var</code> block to simplify the setup code.</li><li>Replace <code>AfterEach</code> with idiomatic Go <code>defer</code>.</li><li>For <code>JustBeforeEach</code>, you can simply inline the code right before the assertion. If it needs more logic, you can extract to a function and call it right before the assertion.</li></ul><p>This way, we can enjoy the best of both worlds: the simplicity of goconvey with the power of gomega!</p><p>But there is still one problem: to focus on a single <code>Convey</code> block, you have to set <code>FocusConvey</code> at every level, from the outermost <code>Convey</code> to the innermost <code>Convey</code>. Then delete each one after finishing your tests&hellip; 😮‍💨</p><h2 id="solution-make-fconvey-smarter">Solution: Make <code>FConvey</code> smarter</h2><p>To understand how &ldquo;ezpkg.io/conveyz&rdquo; <code>FConvey</code> works, let&rsquo;s first look at how &ldquo;ginkgo&rdquo; <code>FIt</code> works and why &ldquo;goconvey&rdquo; <code>FocusConvey</code> requires manual setting at every level.</p><h3 id="ginkgo-how-a-single-fit-can-focus-on-a-test">ginkgo: How a single <code>FIt</code> can focus on a test</h3><p>In ginkgo, inside each <code>Describe</code>|<code>Context</code> block, you can set <code>FIt</code> or <code>FContext</code> to focus on that block.</p><p>For example, with the following code: When you set <code>FIt(&quot;should error (invalid username)&quot;)</code>, it will only exec that test and skip others.</p><p>Specifically, it execs in this order (🟢 for exec and 🟡 for skip):<br></p><ul><li>Start with 🟢 <code>Describe(&quot;UserService&quot;)</code> → 🟢 <code>BeforeEach</code> → 🟢 <code>Context(&quot;SignUp&quot;)</code> → 🟢 <code>BeforeEach</code></li><li>→ 🟡 skip <code>Context(&quot;valid username &amp; password&quot;)</code> → 🟡 skip <code>BeforeEach</code> inside → 🟡 skip all <code>It</code>s inside</li><li>→ 🟢 exec <code>Context(&quot;invalid username&quot;)</code> → 🟢 <code>BeforeEach</code><br><ul><li>→ 🟡 skip <code>It(&quot;should record failure&quot;)</code><br></li><li>→ ✅ exec <code>FIt(&quot;should error (invalid username)&quot;)</code></li></ul></li><li>→ 🟡 skip all remaining non-focus <code>Context</code>s</li></ul><p>It can be able to do that, because when run the <code>Context(&quot;valid username &amp; password&quot;)</code>, it calls <code>BeforeEach</code>, but that <code>BeforeEach</code> does not actually run any logic inside - it only registers the logic to execute later.<br>Then there are 2 scenarios:</p><ul><li>If ginkgo does not encounter any <code>FIt</code> (or <code>PIt</code> for pending),<br>it will 🟢 execute all the registered logic.</li><li>If ginkgo encounters an <code>FIt</code>, it will only 🟢 execute that <code>It</code> (and all logic to that path),<br>but 🟡 skip all other registered logic outside the execution path.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 🟢 start with Describe
</span><span class="c1"></span><span class="nf">Describe</span><span class="p">(</span><span class="s">&#34;UserService&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 🟢 execute this BeforeEach block
</span><span class="c1"></span>    <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ctrl</span> <span class="p">=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nf">GinkgoT</span><span class="p">())</span>
        <span class="nx">mockRepo</span> <span class="p">=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewMockProfileRepository</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="c1">// 🟢 execute this Context
</span><span class="c1"></span>    <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;SignUp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">SignUpRequest</span>
        <span class="c1">// 🟢 execute this BeforeEach block
</span><span class="c1"></span>        <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">req</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">SignUpRequest</span><span class="p">{</span>
                <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
                <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;password123&#34;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="c1">// 🟡 all non-focused Context are skipped
</span><span class="c1"></span>        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;valid username &amp; password&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 🟡 skip this BeforeEach block
</span><span class="c1"></span>            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span>
                    <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">).</span>
                    <span class="nf">Return</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="c1">// 🟡 skip this It
</span><span class="c1"></span>            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should success&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 🟢 execute this BeforeEach block
</span><span class="c1"></span>            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="p">=</span> <span class="s">&#34;admin@&#34;</span>
            <span class="p">})</span>
            <span class="c1">// 🟡 skip this It
</span><span class="c1"></span>            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should record failure&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...
</span><span class="c1"></span>            <span class="p">})</span>
            <span class="c1">// ✅👉 put FIt here to focus on the test 👈
</span><span class="c1"></span>            <span class="nf">FIt</span><span class="p">(</span><span class="s">&#34;should error (invalid username)&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...    
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
        <span class="c1">// 🟡 all non-focused Context are skipped
</span><span class="c1"></span>        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;invalid password: too short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">BeforeEach</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;****&#34;</span>
            <span class="p">})</span>
            <span class="nf">It</span><span class="p">(</span><span class="s">&#34;should error (password too short)&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...    
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
    <span class="c1">// 🟡 all non-focused Context are skipped
</span><span class="c1"></span>    <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;Login&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">Context</span><span class="p">(</span><span class="s">&#34;valid login&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// ...
</span><span class="c1"></span>        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div><h3 id="but-goconvey-focusconvey-must-be-set-at-every-level">But &ldquo;goconvey&rdquo; <code>FocusConvey</code> must be set at every level</h3><p>Because if you only set <code>FocusConvey</code> at the leaf level without setting it at the parent level, it will not skip the parent level.<br></p><ul><li>When it runs a parent <code>Convey</code> block, it will run all the code inside, including the before-each logic (the <code>BeforeEach</code> blocks in previous &ldquo;ginkgo&rdquo; example).</li><li>Unknown &ldquo;ginkgo&rdquo;, which registers the before-each logic inside <code>BeforeEach</code> blocks without actually execute it, &ldquo;goconvey&rdquo; does not have that privilege:<br>It has to run the <code>Convey</code> block to know if there is any <code>FocusConvey</code> inside!</li></ul><p>So you get idea: No way to know if there is any <code>FocusConvey</code> inside without actually running the <code>Convey</code> block, including the before-each logic!</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 🟢 start with Convey
</span><span class="c1"></span><span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;UserService&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 🟢 execute this &#34;BeforeEach&#34; block
</span><span class="c1"></span>    <span class="nx">ctrl</span> <span class="p">=</span> <span class="nx">gomock</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nf">GinkgoT</span><span class="p">())</span>
    <span class="nx">mockRepo</span> <span class="p">=</span> <span class="nx">mocks</span><span class="p">.</span><span class="nf">NewMockProfileRepository</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span>
    
    <span class="c1">// 🟢 execute this Context
</span><span class="c1"></span>    <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;SignUp&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// 🟢 execute this BeforeEach block
</span><span class="c1"></span>        <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">SignUpRequest</span><span class="p">{</span>
            <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;admin&#34;</span><span class="p">,</span>
            <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;password123&#34;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1">// 🟡 all non-focused Convey are skipped
</span><span class="c1"></span>        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;valid username &amp; password&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 🟡 skip this &#34;BeforeEach&#34; block
</span><span class="c1"></span>            <span class="c1">// ❌ but how? goconvey does not have BeforeEach to 
</span><span class="c1"></span>            <span class="c1">//    register the logic beforehand without actually execute it ❌
</span><span class="c1"></span>            <span class="c1">// ❌ the Convey still needs to run to know if there is any FocusConvey inside ❌
</span><span class="c1"></span>            <span class="nx">mockRepo</span><span class="p">.</span><span class="nf">EXPECT</span><span class="p">().</span>
                <span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">).</span>
                <span class="nf">Return</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span>
            
            <span class="c1">// 🟡 skip this Convey
</span><span class="c1"></span>            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should success&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid username&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// 🟢 run this &#34;BeforeEach&#34; block
</span><span class="c1"></span>            <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="p">=</span> <span class="s">&#34;admin@&#34;</span>
            
            <span class="c1">// 🟡 skip this Convey
</span><span class="c1"></span>            <span class="c1">// ❌ but how? it still needs to run it to know if there is any FocusConvey inside ❌
</span><span class="c1"></span>            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should record failure&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...
</span><span class="c1"></span>            <span class="p">})</span>
            <span class="c1">// ✅👉 put FocusConvey here to focus on the test 👈
</span><span class="c1"></span>            <span class="nf">FocusConvey</span><span class="p">(</span><span class="s">&#34;should error (invalid username)&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...    
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
        <span class="c1">// 🟡 all non-focused Convey are skipped
</span><span class="c1"></span>        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;invalid password: too short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="p">=</span> <span class="s">&#34;****&#34;</span>
            
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;should error (password too short)&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// ...    
</span><span class="c1"></span>            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
    <span class="c1">// 🟡 all non-focused Convey are skipped
</span><span class="c1"></span>    <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;Login&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;valid login&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// ...
</span><span class="c1"></span>        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div><h3 id="ezpkgioconveyz-set-a-single-fconvey-to-focus-on-a-test">ezpkg.io/conveyz: Set a single <code>FConvey</code> to focus on a test</h3><p>Okay, now we know why &ldquo;goconvey&rdquo; <code>FocusConvey</code> requires manual setting at every level. But how does &ldquo;ezpkg.io/conveyz&rdquo; <a href="https://pkg.go.dev/ezpkg.io/conveyz#FConvey"><code>FConvey</code></a> workaround that limitation? What&rsquo;s the magic behind it?</p><p>Turns out, it&rsquo;s quite simple: Instead of running the <code>Convey</code> blocks, <em><strong>we can first read the source code and find all the <code>FConvey</code> (or <code>SConvey</code>) inside!</strong></em> When we know locations of all the <code>Convey</code> blocks, we can set the execution focus only on the path to the <code>FConvey</code> block, and skip all others. ✅</p><p>Now you know the trick, it&rsquo;s time to see the implementation of <code>FConvey</code> in &ldquo;ezpkg.io/conveyz&rdquo;:</p><p><strong>Read the source code for the current package</strong></p><p>The first time any <code>Convey</code>|<code>FConvey</code>|<code>SkipConvey</code>, we need to initialize everything: read the source code and find all <code>FConvey</code>.</p><p>To read the source code, we can use <code>runtime.Caller()</code> to get the current file path:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">currentFile</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">Caller</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div><p>Then <a href="https://github.com/ezpkg/ezpkg/blob/ce59fe2d591e0786d4587dbc1e4c50abcf1747f3/conveyz/focus.go#L53-L79">read all the test files</a> and store in to a <code>fileMap</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">fileMap</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">testFile</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nf">parseDir</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">detected</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">entries</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadDir</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">entries</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nf">IsDir</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nf">Name</span><span class="p">(),</span> <span class="s">&#34;_test.go&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">IndexAny</span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nf">Name</span><span class="p">(),</span> <span class="s">&#34;_.&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">continue</span> <span class="c1">// files start with &#34;_&#34; or &#34;.&#34; are ignored
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">entry</span><span class="p">.</span><span class="nf">Name</span><span class="p">())</span>
        <span class="nx">data</span> <span class="o">:=</span> <span class="nf">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
        <span class="nx">file</span><span class="p">,</span> <span class="nx">_detected</span> <span class="o">:=</span> <span class="nf">parseFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
        <span class="nx">fileMap</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="p">=</span> <span class="nx">file</span>
        <span class="nx">detected</span> <span class="p">=</span> <span class="nx">detected</span> <span class="o">||</span> <span class="nx">_detected</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">detected</span>
<span class="p">}</span>
</code></pre></div><p><strong>Find any <code>FConvey</code> inside the source code</strong></p><p>To find any <code>FConvey</code> inside the source code, we can simply <a href="https://github.com/ezpkg/ezpkg/blob/ce59fe2d591e0786d4587dbc1e4c50abcf1747f3/conveyz/focus.go#L81-L97">read the file</a> line by line and check if it contains <code>FConvey(</code> or <code>FocusConvey(</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">parseFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">data</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">testFile</span><span class="p">,</span> <span class="nx">detected</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tf</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">testFile</span><span class="p">{</span><span class="nx">Path</span><span class="p">:</span> <span class="nx">path</span><span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tl</span> <span class="o">:=</span> <span class="nx">testLine</span><span class="p">{</span>
            <span class="nx">Indent</span><span class="p">:</span> <span class="nf">countTabs</span><span class="p">(</span><span class="nx">line</span><span class="p">),</span>
            <span class="nx">Text</span><span class="p">:</span>   <span class="nx">line</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;FConvey(&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;FocusConvey(&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">detected</span> <span class="p">=</span> <span class="kc">true</span>
            <span class="nx">tl</span><span class="p">.</span><span class="nx">FConvey</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;Convey(&#34;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tl</span><span class="p">.</span><span class="nx">Convey</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">,</span> <span class="nx">tl</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">tf</span><span class="p">,</span> <span class="nx">detected</span>
<span class="p">}</span>
</code></pre></div><p><strong>Convert each <code>Convey</code> to <code>FocusConvey</code> or <code>SkipConvey</code></strong></p><p>The case for no <code>FConvey</code> in all files is trivial: no need to do anything.</p><p>But if there is any <code>FConvey</code> in any file, we need to convert the <code>Convey</code> block to <code>FocusConvey</code> or <code>SkipConvey</code> to only execute the relevant blocks on the focus path and skip others.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Convey</span><span class="p">(</span><span class="nx">items</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nf">setupGomega</span><span class="p">(</span><span class="nx">items</span><span class="o">...</span><span class="p">)()</span>
    <span class="k">if</span> <span class="p">!</span><span class="nf">pkgHasFocusConvey</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">convey</span><span class="p">.</span><span class="nf">Convey</span><span class="p">(</span><span class="nx">items</span><span class="o">...</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="nf">shouldConvert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nx">convey</span><span class="p">.</span><span class="nf">FocusConvey</span><span class="p">(</span><span class="nx">items</span><span class="o">...</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="nx">convey</span><span class="p">.</span><span class="nf">SkipConvey</span><span class="p">(</span><span class="nx">items</span><span class="o">...</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nx">convey</span><span class="p">.</span><span class="nf">Convey</span><span class="p">(</span><span class="nx">items</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><strong>Implement <code>shouldConvert()</code></strong></p><p>Now we have all the <code>FConvey</code> locations, let&rsquo;s define some rules to know which <code>Convey</code> should be executed and which should be skipped:</p><p><strong>Case 1:</strong> If there is no <code>FConvey</code> in the current file: it means the focused block is in another file, we can simply return <code>-1</code> to convert the whole <code>Convey</code> block to <code>SkipConvey</code>.</p><p><strong>Case 2:</strong> If there is any <code>FConvey</code> in the current file: we need to check if any parent or child block has <code>FocusConvey</code> (or <code>FConvey</code>), and convert the <code>Convey</code> block to <code>FocusConvey</code> if it has.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Convey        -&gt; 🟢 convert to FocusConvey (parent)
  Convey      -&gt; leave it as is
    Convey    -&gt; leave it as is
  FConvey     -&gt; ✅ convert to FocusConvey (.)
    Convey    -&gt; 🟢 convert to FocusConvey (child)
  Convey      -&gt; leave it as is
    Convey    -&gt; leave it as is
</code></pre></div><p><a href="https://github.com/ezpkg/ezpkg/blob/ce59fe2d591e0786d4587dbc1e4c50abcf1747f3/conveyz/focus.go#L115-L180">The final code</a> looks like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">shouldConvert</span><span class="p">()</span> <span class="p">(</span><span class="nx">out</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">lineNumber</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">Caller</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="nx">tf</span> <span class="o">:=</span> <span class="nx">fileMap</span><span class="p">[</span><span class="nx">file</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">tf</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c1">// leave it as is
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="nx">lineIndex</span> <span class="o">:=</span> <span class="nx">lineNumber</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">{</span>
        <span class="c1">// CASE 2: detect FocusConvey in child or parent blocks
</span><span class="c1"></span>        <span class="c1">// -&gt; return 1: convert the Convey block to FocusConvey
</span><span class="c1"></span>        <span class="nx">line</span> <span class="o">:=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">lineIndex</span><span class="p">]</span>
        <span class="c1">// check if the child code lines inside this convey block has FocusConvey (or FConvey)
</span><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">lineNumber</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Indent</span> <span class="o">&lt;=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">Indent</span> <span class="o">&amp;&amp;</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Indent</span> <span class="o">!=</span> <span class="mi">0</span> <span class="cm">/* skip empty lines */</span> <span class="p">{</span>    
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">FConvey</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c1">// convert to FocusConvey
</span><span class="c1"></span>            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// check if the parent code lines of this convey block has FocusConvey (or FConvey)
</span><span class="c1"></span>        <span class="k">for</span> <span class="nx">parent</span> <span class="o">:=</span> <span class="nf">getParent</span><span class="p">(</span><span class="nx">tf</span><span class="p">,</span> <span class="nx">lineIndex</span><span class="p">);</span> <span class="nx">parent</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">parent</span> <span class="p">=</span> <span class="nf">getParent</span><span class="p">(</span><span class="nx">tf</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">parent</span><span class="p">].</span><span class="nx">FConvey</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c1">// convert to FocusConvey
</span><span class="c1"></span>            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">{</span>
        <span class="c1">// CASE 1: detect if there is no FConvey or FocusConvey in the whole file
</span><span class="c1"></span>        <span class="c1">// -&gt; return -1: convert the Convey block to SkipConvey
</span><span class="c1"></span>        <span class="nx">detected</span> <span class="o">:=</span> <span class="kc">false</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">line</span><span class="p">.</span><span class="nx">FConvey</span> <span class="p">{</span>
                <span class="nx">detected</span> <span class="p">=</span> <span class="kc">true</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">detected</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// convert to SkipConvey
</span><span class="c1"></span>        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getParent</span><span class="p">(</span><span class="nx">tf</span> <span class="o">*</span><span class="nx">testFile</span><span class="p">,</span> <span class="nx">lineIndex</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">line</span> <span class="o">:=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">lineIndex</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">lineIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Indent</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="c1">// skip empty lines
</span><span class="c1"></span>            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Indent</span> <span class="o">&gt;=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">Indent</span> <span class="p">{</span>
            <span class="c1">// skip lines with same or greater indent
</span><span class="c1"></span>            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Indent</span> <span class="p">&lt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">Indent</span> <span class="p">{</span>
            <span class="c1">// found the parent
</span><span class="c1"></span>            <span class="k">return</span> <span class="nx">i</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div><p>And that&rsquo;s it! Now you know how &ldquo;ezpkg.io/conveyz&rdquo; <code>FConvey</code> works, and why it fixes the problem of &ldquo;goconvey&rdquo; <code>FocusConvey</code>!</p><h2 id="the-best-of-both-worlds">The best of both worlds</h2><p>With <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a>, you can enjoy the simplicity of &ldquo;goconvey&rdquo; and the power of &ldquo;gomega&rdquo; in a single package. You can focus on the test itself, not the setup, and use the same assertions as gomega. And with <code>FConvey</code>, you can focus on a single block and propagate to all relevant nested and parent blocks, streamlining the debugging process.</p><p>It also comes with other small and nice things like:</p><ul><li>Cleaner and focused stacktrace with better message.</li><li><code>FConvey</code>|<code>SConvey</code> make <code>go test</code> failure as default so you don&rsquo;t accidentally skip the test.</li><li><a href="https://pkg.go.dev/ezpkg.io/conveyz#SkipConveyAsTODO">SkipConveyAsTODO</a> to actually skip the test without failing the <code>go test</code>.</li></ul><p>So, what are you waiting for? Give <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a> a try and let me know what you think! Feel free to <a href="https://github.com/ezpkg/ezpkg/issues">open an issue</a> or <a href="https://github.com/ezpkg/ezpkg/pulls">submit a pull request</a>.<br>I&rsquo;m always happy to hear from you! 🚀</p><hr><h3 id="subscribe">Let's stay connected!</h3><div>If you like the post, subscribe to <a href="https://olivernguyen.substack.com/">my newsletter</a> to get latest updates:</div><div id="subscription-form"><iframe src="https://olivernguyen.substack.com/embed" width="100%" height="160" style="border:1px solid #eee;border-radius:4px;box-shadow:1px 1px 2px 0 #eee;background:0 0" frameborder="0" scrolling="no"></iframe></div><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>or <a href="https://olivernguyen.substack.com">subscribe to my posts</a>.</span></p></div></article><div id="header-post"><div class="menu-icons"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="header-toc"><nav id="TableOfContents"><ul><li><a href="#the-motivation-behind-ezpkgioconveyzhttpsezpkgioconveyz">The motivation behind <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a></a><ul><li><a href="#ginkgo-and-gomega-are-great-but-verbose">Ginkgo and Gomega are great, but verbose</a></li><li><a href="#convey-focus-on-the-test-not-the-setup">Convey: Focus on the test, not the setup</a></li><li><a href="#problems-incompatible-assertions-and-repeated-focusconvey">Problems: Incompatible assertions and repeated <code>FocusConvey</code></a></li></ul></li><li><a href="#meet-ezpkgioconveyz">Meet ezpkg.io/conveyz</a></li><li><a href="#solution-make-gomega-ω-work-with-goconvey">Solution: Make &ldquo;gomega&rdquo; <code>Ω</code> work with &ldquo;goconvey&rdquo;</a></li><li><a href="#solution-make-fconvey-smarter">Solution: Make <code>FConvey</code> smarter</a><ul><li><a href="#ginkgo-how-a-single-fit-can-focus-on-a-test">ginkgo: How a single <code>FIt</code> can focus on a test</a></li><li><a href="#but-goconvey-focusconvey-must-be-set-at-every-level">But &ldquo;goconvey&rdquo; <code>FocusConvey</code> must be set at every level</a></li><li><a href="#ezpkgioconveyz-set-a-single-fconvey-to-focus-on-a-test">ezpkg.io/conveyz: Set a single <code>FConvey</code> to focus on a test</a></li></ul></li><li><a href="#the-best-of-both-worlds">The best of both worlds</a></li></ul></nav></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script></script><div class="toc-header"><a href="#">ezpkg.io/conveyz: Understanding the Implementation of FConvey</a></div><nav id="TableOfContents"><ul><li><a href="#the-motivation-behind-ezpkgioconveyzhttpsezpkgioconveyz">The motivation behind <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a></a><ul><li><a href="#ginkgo-and-gomega-are-great-but-verbose">Ginkgo and Gomega are great, but verbose</a></li><li><a href="#convey-focus-on-the-test-not-the-setup">Convey: Focus on the test, not the setup</a></li><li><a href="#problems-incompatible-assertions-and-repeated-focusconvey">Problems: Incompatible assertions and repeated <code>FocusConvey</code></a></li></ul></li><li><a href="#meet-ezpkgioconveyz">Meet ezpkg.io/conveyz</a></li><li><a href="#solution-make-gomega-ω-work-with-goconvey">Solution: Make &ldquo;gomega&rdquo; <code>Ω</code> work with &ldquo;goconvey&rdquo;</a></li><li><a href="#solution-make-fconvey-smarter">Solution: Make <code>FConvey</code> smarter</a><ul><li><a href="#ginkgo-how-a-single-fit-can-focus-on-a-test">ginkgo: How a single <code>FIt</code> can focus on a test</a></li><li><a href="#but-goconvey-focusconvey-must-be-set-at-every-level">But &ldquo;goconvey&rdquo; <code>FocusConvey</code> must be set at every level</a></li><li><a href="#ezpkgioconveyz-set-a-single-fconvey-to-focus-on-a-test">ezpkg.io/conveyz: Set a single <code>FConvey</code> to focus on a test</a></li></ul></li><li><a href="#the-best-of-both-worlds">The best of both worlds</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fconveyz%2f&title=ezpkg.io%2fconveyz%3a%20Understanding%20the%20Implementation%20of%20FConvey"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fconveyz%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fconveyz%2f&text=ezpkg.io%2fconveyz%3a%20Understanding%20the%20Implementation%20of%20FConvey"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fconveyz%2f&title=ezpkg.io%2fconveyz%3a%20Understanding%20the%20Implementation%20of%20FConvey"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fconveyz%2f&t=ezpkg.io%2fconveyz%3a%20Understanding%20the%20Implementation%20of%20FConvey"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2025 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><div class="body-right"></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>