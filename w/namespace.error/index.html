<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Errors, Errors Everywhere: How We Centralized and Structured Error Handling | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="Errors, Errors Everywhere: How We Centralized and Structured Error Handling"><meta property="og:description" content="Handling errors in Go is simple and flexible – yet no structure!
It&rsquo;s supposed to be simple, right? Just return an error , wrapped with a message, and move on. Well, that simplicity quickly turns into chaotic as our codebase grows with more packages, more developers, and more &ldquo;quick fixes&rdquo; that stay there forever. Over time, the logs are full of &ldquo;failed to do this&rdquo; and &ldquo;unexpected that&rdquo;, and nobody knows if it’s the user’s fault, the server’s fault, buggy code, or it&rsquo;s just a misalignment of the stars!"><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/namespace.error/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2024-12-06T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-06T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="Errors, Errors Everywhere: How We Centralized and Structured Error Handling"><meta name="twitter:description" content="Handling errors in Go is simple and flexible – yet no structure!
It&rsquo;s supposed to be simple, right? Just return an error , wrapped with a message, and move on. Well, that simplicity quickly turns into chaotic as our codebase grows with more packages, more developers, and more &ldquo;quick fixes&rdquo; that stay there forever. Over time, the logs are full of &ldquo;failed to do this&rdquo; and &ldquo;unexpected that&rdquo;, and nobody knows if it’s the user’s fault, the server’s fault, buggy code, or it&rsquo;s just a misalignment of the stars!"><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/namespace.error/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script src="/script.js"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Errors, Errors Everywhere: How We Centralized and Structured Error Handling</h1><div class="meta"><div class="postdate"><time datetime="2024-12-06 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-12-06</time></div><div class="article-tag">&nbsp;·&nbsp; <a class="tag-link" href="/w/#go" rel="tag">go</a></div>&nbsp;·&nbsp;&nbsp;<a href="#subscribe">subscribe to my posts</a><div class="published-at">published at <a target="_blank" href="https://blog.connectly.ai/errors-errors-everywhere-how-we-centralized-and-structured-error-handling-in-go-089765ccea23">Connectly.ai</a></div></div></header><div class="content" itemprop="articleBody"><p><em>Handling errors in Go is simple and flexible – yet no structure!</em></p><p><em>It&rsquo;s supposed to be simple, right? Just return an <code>error</code> , wrapped with a message, and move on. Well, that simplicity quickly turns into chaotic as our codebase grows with more packages, more developers, and more &ldquo;quick fixes&rdquo; that stay there forever. Over time, the logs are full of &ldquo;failed to do this&rdquo; and &ldquo;unexpected that&rdquo;, and nobody knows if it’s the user’s fault, the server’s fault, buggy code, or it&rsquo;s just a misalignment of the stars!</em></p><p><em>Errors are created with inconsistent messages. Each package has it own set of styles, constants, or custom error types. Error codes are added arbitrarily. No easy way to tell which errors may be returned from which function without digging into its implementation!</em></p><p><em>So, I took the challenge of creating a new error framework. We decided to go with a structured, centralized system using namespace codes to make errors meaningful, traceable, and – most importantly – give us peace of mind!</em></p><p><em>This is the story of how we started with a simple error handling approach, got thoroughly frustrated as the problems grew, and eventually built our own error framework. The design decisions, how it&rsquo;s implemented, the lessons learned, and why it transformed our approach to managing errors. I hope that it will bring some ideas for you too!</em></p><hr><h2 id="go-errors-are-just-values">Go errors are just values</h2><p>Go has a straightforward way to handle errors: errors are just values. An error is just a value that implements the <code>error</code> interface with a single method <code>Error() string</code>. Instead of throwing an exception and disrupting the current execution flow, Go functions return an <code>error</code> value alongside other results. The caller can then decide how to handle it: check its value to make decision, wrap with new messages and context, or simply return the error, leaving the handling logic for parent callers.</p><p>We can make any type an <code>error</code> by adding the <code>Error() string</code> method on it. This flexibility allows each package to define its own error-handling strategy, and choose whatever works best for them. This also integrates well with Go&rsquo;s philosophy of composability, making it easy to wrap, extend, or customize errors as required.</p><h2 id="every-package-needs-to-deal-with-errors">Every package needs to deal with errors</h2><p>The common practice is to return an error value that implements the <code>error</code> interface and lets the caller decide what to do next. Here&rsquo;s a typical example:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">loadCredentials</span><span class="p">()</span> <span class="p">(</span><span class="nx">Credentials</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="s">&#34;cred.json&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">ErrNotExist</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;file not found: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to read file: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">cred</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">verifyCredentials</span><span class="p">(</span><span class="nx">cred</span><span class="p">);</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid credentials: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">cred</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p><strong>Go provides a handful of utilities for working with errors:</strong></p><ul><li><strong>Creating errors:</strong> <code>errors.New()</code> and <code>fmt.Errorf()</code> for generating simple errors.</li><li><strong>Wrapping errors:</strong> Wrap errors with additional context using <code>fmt.Errorf()</code> and the <code>%w</code> verb.</li><li><strong>Combining errors:</strong> <code>errors.Join()</code> merges multiple errors into a single one.</li><li><strong>Checking and handling errors:</strong> <code>errors.Is()</code> matches an error with a specific value, <code>errors.As()</code> matches an error to a specific type, and <code>errors.Unwrap()</code> retrieves the underlying error.</li></ul><p><strong>In practice, we usually see these patterns:</strong></p><ul><li><strong>Using standard packages:</strong> Returning simple errors with <code>errors.New()</code> or <code>fmt.Errorf()</code>.</li><li><strong>Exporting constants or variables:</strong> For instance, <a href="https://github.com/redis/go-redis/blob/master/internal/pool/pool.go">go-redis</a> and <a href="https://github.com/go-gorm/gorm/blob/master/errors.go">gorm.io</a> define reusable error variables.</li><li><strong>Custom error types:</strong> Libraries like <a href="https://github.com/lib/pq/blob/master/error.go">lib/pq</a> or <a href="https://github.com/grpc/grpc-go/blob/master/internal/status/status.go#L207">grpc/status.Error</a> create specialized error types, often with associated codes for additional context.</li><li><strong>Error interfaces with implementations:</strong> The <a href="https://github.com/aws/aws-sdk-go/blob/main/aws/awserr/error.go">aws-sdk-go</a> uses an interface-based approach to define error types with various implementations.</li><li><strong>Or multiple interfaces:</strong> Like <a href="https://github.com/SUSE/docker/blob/master/errdefs/defs.go">Docker&rsquo;s errdefs</a>, which defines multiple interfaces to classify and manage errors.</li></ul><hr><h2 id="we-started-with-a-common-approach">We started with a common approach</h2><p>In the early days, like many Go developers, we followed Go&rsquo;s common practices and kept error handling minimal yet functional. It worked well enough for a couple of years.</p><ul><li>Include stacktrace using <a href="https://github.com/pkg/errors">pkg/errors</a>, a popular package at that time.</li><li>Export constants or variables for package-specific errors.</li><li>Use <code>errors.Is()</code> to check for specific errors.</li><li>Wrap errors with a new messages and context.</li><li>For API errors, we define error types and codes with Protobuf enum.</li></ul><p><strong>Including stacktrace with <code>pkg/errors</code></strong></p><p>We used <a href="https://github.com/pkg/errors">pkg/errors</a>, a popular error-handling package at the time, to include stacktrace in our errors. This was particularly helpful for debugging, as it allowed us to trace the origin of errors across different parts of the application.</p><p>To create, wrap, and propagate errors with stacktrace, we implemented functions like <code>Newf()</code>, <code>NewValuef()</code>, and <code>Wrapf()</code>. Here&rsquo;s an example of our early implementation:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">xError</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">msg</span>   <span class="kt">string</span>
    <span class="nx">stack</span> <span class="nx">frames</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Newf</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">xError</span><span class="p">{</span>  
        <span class="nx">msg</span><span class="p">:</span>   <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">),</span>  
        <span class="nx">stack</span><span class="p">:</span> <span class="nf">callers</span><span class="p">(),</span>  <span class="c1">// 👈 stacktrace
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">NewValuef</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>  <span class="c1">// 👈 no stacktrace
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="nx">stack</span> <span class="o">:=</span> <span class="nf">getStack</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">stack</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="nx">stack</span> <span class="p">=</span> <span class="nf">callers</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">xError</span><span class="p">{</span>
        <span class="nx">msg</span><span class="p">:</span>   <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">),</span>
        <span class="nx">stack</span><span class="p">:</span> <span class="nx">stack</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><strong>Exporting error variables</strong></p><p>Each package in our codebase defined its own error variables, often with inconsistent styles.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">database</span>

<span class="kd">var</span> <span class="nx">ErrNotFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;record not found&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">ErrMultipleFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;multiple records found&#34;</span><span class="p">)</span>    
<span class="kd">var</span> <span class="nx">ErrTimeout</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;request timeout&#34;</span><span class="p">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile</span>

<span class="kd">var</span> <span class="nx">ErrUserNotFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;user not found&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">ErrBusinessNotFound</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;business not found&#34;</span><span class="p">)</span>     
<span class="kd">var</span> <span class="nx">ErrContextCancel</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewValue</span><span class="p">(</span><span class="s">&#34;context canceled&#34;</span><span class="p">)</span>
</code></pre></div><p><strong>Checking errors with <code>errors.Is()</code> and wrapping with additional context</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">QueryUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
        <span class="c1">// continue
</span><span class="c1"></span>    <span class="k">case</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">ErrUserNotFound</span><span class="p">,</span> <span class="s">&#34;user not found (id=%v)&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>    
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;failed to query user (id=%v)&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>This helped propagate errors with more detail but often resulted in verbosity, duplication, and less clarity in logs:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">internal server error: failed to query user: user not found (id=52a0a433-3922-48bd-a7ac-35dd8972dfe5): record not found: not found    
</code></pre></div><p><strong><b id="protobuf-code">Defining external errors with Protobuf</b></strong></p><p>For external-facing APIs, we adopted a Protobuf-based error model inspired by <a href="https://developers.facebook.com/docs/graph-api/guides/error-handling#receiving-errorcodes">Meta&rsquo;s Graph API</a>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="kd">message</span> <span class="nc">Error</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ErrorType</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ErrorCode</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>    <span class="kt">string</span> <span class="n">user_title</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="kt">string</span> <span class="n">user_message</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="kt">string</span> <span class="n">trace_id</span>     <span class="o">=</span> <span class="mi">6</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="err">
</span><span class="err"></span>    <span class="n">map</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">details</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err"></span><span class="kd">enum</span> <span class="n">ErrorType</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_AUTHENTICATION</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_INVALID_REQUEST</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_RATE_LIMIT</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_BUSINESS_LIMIT</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_TYPE_WEBHOOK_DELIVERY</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err"></span><span class="kd">enum</span> <span class="n">ErrorCode</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_CODE_UNSPECIFIED</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[(</span><span class="n">error_type</span> <span class="o">=</span> <span class="n">UNSPECIFIED</span><span class="p">)];</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_CODE_UNAUTHENTICATED</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[(</span><span class="n">error_type</span> <span class="o">=</span> <span class="n">AUTHENTICATION</span><span class="p">)];</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_CODE_CAMPAIGN_NOT_FOUND</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">[(</span><span class="n">error_type</span> <span class="o">=</span> <span class="n">NOT_FOUND</span><span class="p">)];</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_CODE_META_CHOSE_NOT_TO_DELIVER</span> <span class="o">=</span> <span class="mi">4</span> <span class="cm">/* ... */</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="n">ERROR_CODE_MESSAGE_WABA_TEMPLATE_CAN_ONLY_EDIT_ONCE_IN_24_HOURS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>    <span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><p>This approach helped structure errors, but over time, error types and codes were added without a clear plan, leading to inconsistencies and duplication.</p><hr><h2 id="and-problems-grew-over-time">And problems grew over time</h2><p><strong>Errors were declared everywhere</strong></p><ul><li>Each package defined its own error constants with no centralized system.</li><li>Constants and messages were scattered across the codebase, making it unclear which errors a function might return – ugh, is it <code>gorm.ErrRecordNotFound</code> or <code>user.ErrNotFound</code> or both?</li></ul><p><strong>Random error wrapping led to inconsistent and arbitrary logs</strong></p><ul><li>Many functions wrapped errors with arbitrary, inconsistent messages without declaring their own error types.</li><li>Logs were verbose, redundant, and difficult to search or monitor.</li><li>Error messages were generic and often didn’t explain what went wrong or how it happened. Also brittle and prone to unnoticed changes.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">unexpected gorm error: failed to find business channel: error received when invoking API: unexpected: context canceled    
</code></pre></div><p><strong>No standardization led to improper error handling</strong></p><ul><li>Each package handled errors differently, making it hard to know if a function returned, wrapped, or transformed errors.</li><li>Context was often lost as errors propagated.</li><li>Upper layers received vague <em>500 Internal Server Errors</em> without clear root causes.</li></ul><p><strong>No categorization made monitoring impossible</strong></p><ul><li>Errors weren’t classified by severity or behavior: A <code>context.Canceled</code> error may be a normal behavior when the user closes the browser tab, but it&rsquo;s important if the request is canceled because that query is randomly slow.</li><li>Important issues were buried under noisy logs, making them hard to identify.</li><li>Without categorization, it was impossible to monitor error frequency, severity, or impact effectively.</li></ul><hr><h2 id="its-time-to-centralize-error-handling">It&rsquo;s time to centralize error handling</h2><h3 id="back-to-the-drawing-board">Back to the drawing board</h3><p>To address the growing challenges, we decided to build a better error strategy around the core idea of <strong>centralized and structured error codes</strong>.</p><ul><li>Errors are declared everywhere → <em>Centralize error declaration in a single place for better organization and traceability.</em></li><li>Inconsistent and arbitrary logs → <em>Structured error codes with clear and consistent formatting.</em></li><li>Improper error handling → <em>Standardize error creation and checking on the new <code>Error</code> type with a comprehensive set of helpers.</em></li><li>No categorization → <em>Categorize error codes with tags for effective monitoring through logs and metrics.</em></li></ul><h3 id="design-decisions">Design decisions</h3><p><strong>All error codes are defined at a centralized place with namespace structure.</strong></p><p>Use namespaces to create clear, meaningful, and extendable error codes. Example:</p><ul><li><code>PRFL.USR.NOT_FOUND</code> for &ldquo;User not found.&rdquo;</li><li><code>FLD.NOT_FOUND</code> for &ldquo;Flow document not found.&rdquo;</li><li>Both can share an underlying base code <code>DEPS.PG.NOT_FOUND</code>, meaning &ldquo;Record not found in PostgreSQL.&rdquo;</li></ul><p><strong>Each layer of service or library must only return its own namespace codes</strong>.</p><ul><li>Each layer of service, repository, or library declares its own set of error codes.</li><li>When a layer receives an error from a dependency, it must wrap it with its own namespace code before returning it.</li><li>For example: When receiving an error <code>gorm.ErrRecordNotFound</code> from a dependency, the &ldquo;database&rdquo; package must wrap it as <code>DEPS.PG.NOT_FOUND</code>. Later, the &ldquo;profile/user&rdquo; service must wrap it again as <code>PRFL.USR.NOT_FOUND</code>.</li></ul><p><strong>All errors must implement the <code>Error</code> interface.</strong></p><ul><li>This creates a clear boundary between errors from third-party libraries (<code>error</code>) and our internal <code>Error</code>s.</li><li>This also helps for migration progress, to separate between migrated packages and not-yet-migrated ones.</li></ul><p><strong>An error can wrap one or multiple errors. Together, they form a tree.</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[FLD.INVALID_ARGUMENT] invalid argument
 → [TPL.INVALID_PARAMS] invalid input params
  1. [TPL.PARAM.EMPTY] name can not be empty
  2. [TPL.PARAM.MALFORM] invalid format for param[2]    
</code></pre></div><p><strong>Always require <code>context.Context</code>. Can attach context to the error.</strong></p><ul><li>Many times we saw logs with standalone errors with no context, no <code>trace_id</code>, and have no idea where it comes from.</li><li>Can attach additional key/value to errors, which can be used in logs or monitoring.</li></ul><p><strong>When errors are sent across service boundary, only the top-level error code is exposed.</strong></p><ul><li>The callers do not need to see the internal implementation details of that service.</li></ul><p><strong>For external errors, keep using the current Protobuf ErrorCode and ErrorType.</strong></p><ul><li>This ensures backward compatibility, so our clients don’t need to rewrite their code.</li></ul><p><strong>Automap namespace error codes to Protobuf codes, HTTP status codes, and tags.</strong></p><ul><li>Engineers define the mapping in the centralized place, and the framework will map each error code to the corresponding Protobuf <code>ErrorCode</code>, <code>ErrorType</code>, gRPC status, HTTP status, and tags for logging/metrics.</li><li>This ensures consistency and reduces duplication.</li></ul><hr><h2 id="the-namespace-error-framework">The namespace error framework</h2><h3 id="core-packages-and-types">Core packages and types</h3><p>There are a few core packages that form the foundation of our new error-handling framework.</p><p><code>connectly.ai/go/pkgs/</code></p><ul><li><strong><code>errors</code></strong>: The main package that defines the <code>Error</code> type and codes.</li><li><strong><code>errors/api</code></strong>: For sending errors to the front-end or external API.</li><li><strong><code>errors/E</code></strong>: Helper package intended to be used with dot import.</li><li><strong><code>testing</code></strong>: Testing utilities for working with namespace errors.</li></ul><p><strong><code>Error</code> and <code>Code</code></strong></p><p>The <code>Error</code> interface is an extension of the standard <code>error</code> interface, with additional methods to return a <code>Code</code>. A <code>Code</code> is implemented as an <code>uint16</code>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">errors</span> <span class="c1">// import &#34;connectly.ai/go/pkgs/errors&#34;
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">Error</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="kt">error</span>
    <span class="nf">Code</span><span class="p">()</span> <span class="nx">Code</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Code</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">code</span> <span class="kt">uint16</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">CodeI</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">CodeDesc</span><span class="p">()</span> <span class="nx">CodeDesc</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">GroupI</span> <span class="kd">interface</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">CodeDesc</span> <span class="kd">struct</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</code></pre></div><p><strong>Package <code>errors/E</code> exports all error codes and common types</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">E</span> <span class="c1">// import &#34;connectly.ai/go/pkgs/errors/E&#34;
</span><span class="c1"></span>
<span class="kn">import</span> <span class="s">&#34;connectly.ai/go/pkgs/errors&#34;</span>

<span class="kd">type</span> <span class="nx">Error</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Error</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">DEPS</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">DEPS</span>
    <span class="nx">PRFL</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">PRFL</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">MapError</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Mapper</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>    
<span class="kd">func</span> <span class="nf">IsErrorCode</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">codes</span> <span class="o">...</span><span class="nx">errors</span><span class="p">.</span><span class="nx">CodeI</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
<span class="kd">func</span> <span class="nf">IsErrorGroup</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">groups</span> <span class="o">...</span><span class="nx">errors</span><span class="p">.</span><span class="nx">GroupI</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</code></pre></div><h3 id="example-usage">Example usage</h3><p>Example error codes:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// dependencies → postgres
</span><span class="c1"></span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span>
<span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">UNEXPECTED</span>

<span class="c1">// sdk → hash
</span><span class="c1"></span><span class="nx">SDK</span><span class="p">.</span><span class="nx">HASH</span><span class="p">.</span><span class="nx">UNEXPECTED</span>

<span class="c1">// profile → user
</span><span class="c1"></span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span>
<span class="nx">PFRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span>

<span class="c1">// profile → user → repository
</span><span class="c1"></span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">NOT_FOUND</span>
<span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">UNKNOWN</span>

<span class="c1">// profile → auth
</span><span class="c1"></span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNAUTHENTICATED</span>
<span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNKNOWN</span>
<span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNEXPECTED</span>
</code></pre></div><p>Package <code>database</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">database</span> <span class="c1">// import &#34;connectly.ai/go/pkgs/database&#34;
</span><span class="c1"></span>
<span class="kn">import</span> <span class="s">&#34;gorm.io/gorm&#34;</span>
<span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;connectly.ai/go/pkgs/errors/E&#34;</span>

<span class="kd">type</span> <span class="nx">DB</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">gorm</span><span class="p">:</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">sql</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="o">*</span><span class="nx">DB</span> <span class="p">{</span>
    <span class="nx">tx</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">gorm</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="nx">params</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">wrapTx</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Error</span><span class="p">(</span><span class="nx">msgArgs</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">wrapError</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>  <span class="c1">// 👈 convert gorm error to &#39;Error&#39;
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">SingleRowError</span><span class="p">(</span><span class="nx">msgArgs</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">x</span><span class="p">.</span><span class="nf">Error</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">err</span> <span class="p">}</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">x</span><span class="p">.</span><span class="nx">RowsAffected</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">nil</span>
    <span class="k">case</span> <span class="nx">x</span><span class="p">.</span><span class="nx">RowsAffected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">CallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span>
            <span class="nf">New</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="nf">formatMsgArgs</span><span class="p">(</span><span class="nx">msgArgs</span><span class="p">))</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">UNEXPECTED</span><span class="p">.</span><span class="nf">CallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span>
            <span class="nf">New</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="nf">formatMsgArgs</span><span class="p">(</span><span class="nx">msgArgs</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Package <code>pb/services/profile</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile</span> <span class="c1">// import &#34;connectly.ai/pb/services/profile&#34;
</span><span class="c1"></span>
<span class="c1">// these types are generated from services/profile.proto
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">QueryUserRequest</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">BusinessId</span> <span class="kt">string</span>
    <span class="nx">UserId</span>     <span class="kt">string</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">LoginRequest</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Username</span> <span class="kt">string</span>
    <span class="nx">Password</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p>Package <code>service/profile</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">profile</span>

<span class="kn">import</span> <span class="nx">uuid</span> <span class="s">&#34;github.com/google/uuid&#34;</span>
<span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;connectly.ai/go/pkgs/errors/E&#34;</span>
<span class="kn">import</span> <span class="nx">l</span> <span class="s">&#34;connectly.ai/go/pkgs/logging/l&#34;</span>
<span class="kn">import</span> <span class="nx">profilepb</span> <span class="s">&#34;connectly.ai/pb/services/profile&#34;</span>

<span class="c1">// repository requests
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">QueryUserByUsernameRequest</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Username</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// repository layer → query user
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">UserRepository</span><span class="p">)</span> <span class="nf">QueryUserByUsernameAuth</span><span class="p">(</span>
    <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">QueryUserByUsernameRequest</span><span class="p">,</span>
<span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="nx">Error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;empty request&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">user</span> <span class="nx">User</span>
    <span class="nx">sqlQuery</span> <span class="o">:=</span> <span class="s">`SELECT * FROM &#34;user&#34; WHERE username = ? LIMIT 1`</span>
    <span class="nx">tx</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sqlQuery</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">).</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>     
    
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">SingleRowError</span><span class="p">()</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span> <span class="kc">nil</span>
        
    <span class="k">case</span> <span class="nf">IsErrorCode</span><span class="p">(</span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">):</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">USER_NOT_FOUND</span><span class="p">.</span>
            <span class="nf">With</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">))</span>
            <span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">)</span>
        
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">.</span>
            <span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;failed to query user&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// user service layer → query user
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">UserService</span><span class="p">)</span> <span class="nf">QueryUser</span><span class="p">(</span>
    <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">QueryUserRequest</span><span class="p">,</span>
<span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">QueryUserResponse</span><span class="p">,</span> <span class="nx">Error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">rr</span> <span class="o">:=</span> <span class="nx">QueryUserByUsernameRequest</span><span class="p">{</span> <span class="nx">Username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="p">}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">repo</span><span class="p">.</span><span class="nf">QueryUserByUsername</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">rr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">MapError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span>
            <span class="nf">Map</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> 
                <span class="s">&#34;the user %q cannot be found&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserName</span><span class="p">,</span>
                <span class="nx">api</span><span class="p">.</span><span class="nf">UserTitle</span><span class="p">(</span><span class="s">&#34;User Not Found&#34;</span><span class="p">),</span>
                <span class="nx">api</span><span class="p">.</span><span class="nf">UserMsg</span><span class="p">(</span><span class="s">&#34;The requested user id %q can not be found&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserId</span><span class="p">)).</span>    
            <span class="nf">KeepGroup</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">).</span>    
            <span class="nf">Default</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">,</span> <span class="s">&#34;failed to query user&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// auth service layer → login user
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AuthService</span><span class="p">)</span> <span class="nf">Login</span><span class="p">(</span>
    <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">LoginRequest</span><span class="p">,</span>
<span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">LoginResponse</span><span class="p">,</span> <span class="o">*</span><span class="nx">profilepb</span><span class="p">.</span><span class="nx">LoginResponse</span><span class="p">,</span> <span class="nx">Error</span><span class="p">)</span> <span class="p">{</span>    

    <span class="nx">vl</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span><span class="nf">WithMsg</span><span class="p">(</span><span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
    <span class="nx">vl</span><span class="p">.</span><span class="nf">Vl</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Username</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;no username&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nf">Detail</span><span class="p">(</span><span class="s">&#34;username is required&#34;</span><span class="p">))</span>
    <span class="nx">vl</span><span class="p">.</span><span class="nf">Vl</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;no password&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nf">Detail</span><span class="p">(</span><span class="s">&#34;password is required&#34;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">vl</span><span class="p">.</span><span class="nf">ToError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">hashpwd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">hash</span><span class="p">.</span><span class="nf">Hash</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNEXPECTED</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to calc hash&#34;</span><span class="p">)</span>    
    <span class="p">}</span>

    <span class="nx">usrReq</span> <span class="o">:=</span> <span class="nx">profilepb</span><span class="p">.</span><span class="nx">QueryUserByUsernameRequest</span><span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
    <span class="nx">usrRes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">userServiceClient</span><span class="p">.</span><span class="nf">QueryUserByUsername</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">usrReq</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">MapError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span>
            <span class="nf">Map</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNAUTHENTICATED</span><span class="p">,</span> <span class="s">&#34;unauthenticated&#34;</span><span class="p">).</span>
            <span class="nf">Default</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">,</span> <span class="s">&#34;failed to query by username&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>Well, there are a lot of new functions and concepts in the above code. Let&rsquo;s go through them step by step.</p><h3 id="creating-and-wrapping-errors">Creating and wrapping errors</h3><p><strong>First, import package <code>errors/E</code> using dot import</strong></p><p>This will allow you to directly use common types like <code>Error</code> instead of <code>errors.Error</code> and access to codes by <code>PRFL.USR.NOT_FOUND</code> instead of <code>errors.PRFL.USR.NOT_FOUND</code>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;connectly.ai/go/pkgs/errors/E&#34;</span>
</code></pre></div><p><strong>Create new errors using <code>CODE.New()</code></strong></p><p>Suppose you get an invalid request, you can create a new error by:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
</code></pre></div><ul><li><code>PRFL.USR.INVALID_ARGUMENT</code> is a <code>Code</code>.</li><li>A <code>Code</code> exposes methods like <code>New()</code> or <code>Wrap()</code> for creating a new error.</li><li>The <code>New()</code> function receives <code>context.Context</code> as the first argument, followed by message and optional arguments.</li></ul><p>Print it with <code>fmt.Print(err)</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[PRFL.USR.INVALID_ARGUMENT] invalid request
</code></pre></div><p>or with <code>fmt.Printf(&quot;%+v&quot;)</code> to see more details:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">]</span> <span class="nx">invalid</span> <span class="nx">request</span>

<span class="nx">connectly</span><span class="p">.</span><span class="nx">ai</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="p">.(</span><span class="o">*</span><span class="nx">UserService</span><span class="p">).</span><span class="nx">QueryUser</span>
    <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">i</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="o">/</span><span class="nx">user</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">1234</span>
<span class="nx">connectly</span><span class="p">.</span><span class="nx">ai</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="p">.(</span><span class="o">*</span><span class="nx">UserRepository</span><span class="p">).</span><span class="nx">QueryUser</span>
    <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">i</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="o">/</span><span class="nx">repo</span><span class="o">/</span><span class="nx">user</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">2341</span>
</code></pre></div><p><strong>Wrap an error within a new error using <code>CODE.Wrap()</code></strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">dbErr</span> <span class="o">:=</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">ErrRecordNotFound</span><span class="p">,</span> <span class="s">&#34;not found&#34;</span><span class="p">)</span>
<span class="nx">usrErr</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">dbErr</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">)</span>
</code></pre></div><p>will produce this output with <code>fmt.Print(usrErr)</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">user</span> <span class="nx">not</span> <span class="nx">found</span> <span class="err">→</span> <span class="p">[</span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">not</span> <span class="nx">found</span> <span class="err">→</span> <span class="nx">record</span> <span class="nx">not</span> <span class="nx">found</span>
</code></pre></div><p>or with <code>fmt.Printf(&quot;%+v&quot;, usrErr)</code></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">user</span> <span class="nx">not</span> <span class="nx">found</span>
  <span class="err">→</span> <span class="p">[</span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">not</span> <span class="nx">found</span>
      <span class="err">→</span> <span class="nx">record</span> <span class="nx">not</span> <span class="nx">found</span>

<span class="nx">connectly</span><span class="p">.</span><span class="nx">ai</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="p">.(</span><span class="o">*</span><span class="nx">UserService</span><span class="p">).</span><span class="nx">QueryUser</span>
    <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">i</span><span class="o">/</span><span class="nx">src</span><span class="o">/</span><span class="k">go</span><span class="o">/</span><span class="nx">services</span><span class="o">/</span><span class="nx">profile</span><span class="o">/</span><span class="nx">user</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">1234</span>
</code></pre></div><p>The stacktrace will come from the innermost <code>Error</code>. If you are writing a helper function, you can use <code>CallerSkip(skip)</code> to skip frames:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mapUserError</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">IsErrorCode</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">):</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">CallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;...&#34;</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">.</span><span class="nf">CallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;...&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="adding-context-to-errors">Adding context to errors</h3><p><strong>Add context to an error using <code>With()</code></strong></p><ul><li>You can add additional key/value pairs to errors by <code>.With(l.String(...))</code>.</li><li><code>logging/l</code> is a helper package to export sugar functions for logging.</li><li><code>l.String(&quot;flag&quot;, flag)</code> return a <code>Tag{String: flag}</code> and <code>l.UUID(&quot;user_id, userID)</code> return <code>Tag{Stringer: userID}</code>.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">l</span> <span class="s">&#34;connectly.ai/go/pkgs/logging/l&#34;</span>

<span class="nx">usrErr</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span>
    <span class="nf">With</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nf">UUID</span><span class="p">(</span><span class="s">&#34;user_id&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserID</span><span class="p">),</span> <span class="nx">l</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">)).</span>
    <span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">dbErr</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">)</span>
</code></pre></div><p>The tags can be output with <code>fmt.Printf(&quot;%+v&quot;, usrErr)</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">user</span> <span class="nx">not</span> <span class="nx">found</span>
<span class="p">{</span><span class="s">&#34;user_id&#34;</span><span class="p">:</span> <span class="s">&#34;81febc07-5c06-4e01-8f9d-995bdc2e0a9a&#34;</span><span class="p">,</span> <span class="s">&#34;flag&#34;</span><span class="p">:</span> <span class="s">&#34;ABRW&#34;</span><span class="p">}</span>
  <span class="err">→</span> <span class="p">[</span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">]</span> <span class="nx">not</span> <span class="nx">found</span>
    <span class="p">{</span><span class="s">&#34;a number&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
      <span class="err">→</span> <span class="nx">record</span> <span class="nx">not</span> <span class="nx">found</span>
</code></pre></div><p><strong>Add context to errors directly inside <code>New()</code>, <code>Wrap()</code>, or <code>MapError()</code>:</strong></p><p>By leverage <code>l.String()</code> function and its family, <code>New()</code> and similar functions can smartly detect tags among formatting arguments. No need to introduce different functions.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">INF</span><span class="p">.</span><span class="nx">HEALTH</span><span class="p">.</span><span class="nx">NOT_READY</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> 
    <span class="s">&#34;service %q is not ready (retried %v times)&#34;</span><span class="p">,</span> 
    <span class="nx">req</span><span class="p">.</span><span class="nx">ServiceName</span><span class="p">,</span> 
    <span class="nx">l</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">)</span>
    <span class="nx">countRetries</span><span class="p">,</span>
    <span class="nx">l</span><span class="p">.</span><span class="nf">Number</span><span class="p">(</span><span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">countRetries</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div><p>will output:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="nx">INF</span><span class="p">.</span><span class="nx">HEALTH</span><span class="p">.</span><span class="nx">NOT_READY</span><span class="p">]</span> <span class="nx">service</span> <span class="s">&#34;magic&#34;</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nf">ready</span> <span class="p">(</span><span class="nx">retried</span> <span class="mi">2</span> <span class="nx">times</span><span class="p">)</span>    
<span class="p">{</span><span class="s">&#34;flag&#34;</span><span class="p">:</span> <span class="s">&#34;ABRW&#34;</span><span class="p">,</span> <span class="s">&#34;count&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</code></pre></div><h3 id="different-types-error0-vlerror-apierror">Different types: <code>Error0</code>, <code>VlError</code>, <code>ApiError</code></h3><p>Currently, there are 3 types that implements the <code>Error</code> interfaces. You can add more types if necessary. Each one can have different structure, with custom methods for specific needs.</p><p><strong><code>Error</code> is an extension of Go&rsquo;s standard <code>error</code> interface</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Error</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="kt">error</span>
    <span class="nf">Code</span><span class="p">()</span>
    <span class="nf">Message</span><span class="p">()</span>
    <span class="nf">Fields</span><span class="p">()</span> <span class="p">[]</span><span class="nx">tags</span><span class="p">.</span><span class="nx">Field</span>
    <span class="nf">StackTrace</span><span class="p">()</span> <span class="nx">stacktrace</span><span class="p">.</span><span class="nx">StackTrace</span>

    <span class="nf">_base</span><span class="p">()</span> <span class="o">*</span><span class="nx">base</span> <span class="c1">// a private method
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>It contains a private method to ensure that we don&rsquo;t accidentally implement new <code>Error</code> types outside of the <code>errors</code> package. We may (or may not) lift that restriction in the future when we experience with more usage patterns.</p><p><strong>Why don&rsquo;t we just use the standard <code>error</code> interface and use type assertion?</strong></p><p>Because we want to separate between third-party errors and our internal errors. All layers and packages in our internal codes must always return <code>Error</code>. This way we can safely know when we have to convert third-party errors, and when we only need to deal with our internal error codes.</p><p>It also creates a boundary between migrated packages and not-yet-migrated packages. <em>Back to reality, we cannot just declare a new type, wave a magic wand, whisper a <del>spell</del> prompt, and then all millions lines of code are magically converted and work seamlessly with no bugs!</em> No, that future is not here yet. It may come someday, but for now, we still have to migrate our packages one by one.</p><p><strong><code>Error0</code> is the default <code>Error</code> type</strong></p><p>Most error codes will produce an <code>Error0</code> value. It contains a <code>base</code> and an optional sub-error. You can use <code>NewX()</code> to return a concrete <code>*Error0</code> struct instead of an <code>Error</code> interface, but you need to <a href="https://go.dev/doc/faq#nil_error">be careful</a>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Error0</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">base</span>  
    <span class="nx">err</span> <span class="kt">error</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">errA</span><span class="p">:</span>  <span class="nx">Error</span>  <span class="p">=</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">New</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;not found&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">errB</span><span class="p">:</span> <span class="o">*</span><span class="nx">Error0</span> <span class="p">=</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">NewX</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;not found&#34;</span><span class="p">)</span>
</code></pre></div><p><code>base</code> is the common structure shared by all <code>Error</code> implementation to provide common functionality: <code>Code()</code>, <code>Message()</code>, <code>StackTrace()</code>, <code>Fields()</code>, and more.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">base</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">code</span>  <span class="nx">Code</span>
    <span class="nx">msg</span>   <span class="kt">string</span>
    <span class="nx">kv</span>    <span class="p">[]</span><span class="nx">tags</span><span class="p">.</span><span class="nx">Field</span>
    <span class="nx">stack</span> <span class="nx">stacktrace</span><span class="p">.</span><span class="nx">StackTrace</span>
<span class="p">}</span>
</code></pre></div><p><strong><code>VlError</code> is for validation errors</strong></p><p>It can contain multiple sub-errors, and provide nice methods to work with validation helpers.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">VlError</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">base</span>
    <span class="nx">errs</span> <span class="p">[]</span><span class="kt">error</span>
<span class="p">}</span>
</code></pre></div><p>You can create a <code>VlError</code> similar to other <code>Error</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
</code></pre></div><p>Or make a <code>VlBuilder</code>, add errors to it, then convert it to a <code>VlError</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">userID</span><span class="p">,</span> <span class="nx">err0</span> <span class="o">:=</span> <span class="nf">parseUUID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">UserId</span><span class="p">)</span>
<span class="nx">err1</span> <span class="o">:=</span> <span class="nf">validatePassword</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>

<span class="nx">vl</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span><span class="nf">WithMsg</span><span class="p">(</span><span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
<span class="nx">vl</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">err0</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
<span class="nx">vlErr</span> <span class="o">:=</span> <span class="nx">vl</span><span class="p">.</span><span class="nf">ToError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</code></pre></div><p>And include key/value pairs as usual:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">vl</span> <span class="o">:=</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">INVALID_ARGUMENT</span><span class="p">.</span>
    <span class="nf">With</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;testingenv&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)).</span>
    <span class="nf">WithMsg</span><span class="p">(</span><span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
<span class="nx">userID</span><span class="p">,</span> <span class="nx">err0</span> <span class="o">:=</span> <span class="nf">parseUUID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">UserId</span><span class="p">)</span>
<span class="nx">err1</span> <span class="o">:=</span> <span class="nf">validatePassword</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span>

<span class="nx">vl</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">err0</span><span class="p">,</span> <span class="nx">err1</span><span class="p">)</span>
<span class="nx">vlErr</span> <span class="o">:=</span> <span class="nx">vl</span><span class="p">.</span><span class="nf">ToError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;user_id&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">UserId</span><span class="p">))</span>
</code></pre></div><p>Using <code>fmt.Printf(&quot;%+v&quot;, vlErr)</code> will output:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">[PRFL.USR.INVALID_ARGUMENT] invalid request
{&#34;testingenv&#34;: true, &#34;user_id&#34;: &#34;A1234567890&#34;}
</code></pre></div><p><strong><code>ApiError</code> is an adapter for migrating API errors</strong></p><p>Previously, we used a separate <code>api.Error</code> struct for returning API errors to the front-end and external clients. It includes <code>ErrorType</code> as <code>ErrorCode</code> as <a href="#protobuf-code">mentioned before</a>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">api</span>
<span class="kn">import</span> <span class="nx">errorpb</span> <span class="s">&#34;connectly.ai/pb/models/error&#34;</span>

<span class="c1">// Deprecated
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Error</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">pbType</span> <span class="nx">errorpb</span><span class="p">.</span><span class="nx">ErrorType</span>
    <span class="nx">pbCode</span> <span class="nx">errorpb</span><span class="p">.</span><span class="nx">ErrorCode</span>

    <span class="nx">cause</span>    <span class="kt">error</span>
    <span class="nx">msg</span>      <span class="kt">string</span>
    <span class="nx">usrMsg</span>   <span class="kt">string</span>
    <span class="nx">usrTitle</span> <span class="kt">string</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>This type is now deprecated. Instead, we will declare all the mapping (<code>ErrorType</code>, <code>ErrorCode</code>, gRPC code, HTTP code) in a centralize place, and convert them at corresponding boundaries. I will discuss about code declaration in <a href="#declaring-new-error-codes">the next section</a>.</p><p>To do the migration to the new namespace error framework, we added <em>a temporary namespace</em> <code>ZZZ.API_TODO</code>. Every <code>ErrorCode</code> becomes a <code>ZZZ.API_TODO</code> code.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">UNEXPECTED</span>
<span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">INVALID_REQUEST</span>
<span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">USERNAME_</span>
<span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">META_CHOSE_NOT_TO_DELIVER</span>
<span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">MESSAGE_WABA_TEMPLATE_CAN_ONLY_EDIT_ONCE_IN_24_HOURS</span>
</code></pre></div><p>And <code>ApiError</code> is created as an adapter. All functions that previously return <code>*api.Error</code> were changed to return <code>Error</code> (implemented by <code>*ApiError</code>) instead.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">api</span>
<span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;connectly.ai/go/pkgs/errors/E&#34;</span>

<span class="c1">// previous
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">FailPreconditionf</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="o">*</span><span class="nx">Error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Error</span><span class="p">{</span>
        <span class="nx">pbType</span><span class="p">:</span> <span class="nx">ERROR_TYPE_FAILED_PRECONDITION</span><span class="p">,</span>
        <span class="nx">pbCode</span><span class="p">:</span> <span class="nx">ERROR_CODE_MESSAGE_WABA_TEMPLATE_CAN_ONLY_EDIT_ONCE_IN_24_HOURS</span><span class="p">,</span>    
        <span class="nx">cause</span><span class="p">:</span> <span class="nx">err</span><span class="p">,</span>
        <span class="nx">msg</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span> 

<span class="c1">// current: this is deprecated, and serves and an adapter
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">FailPreconditionf</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="o">*</span><span class="nx">Error</span> <span class="p">{</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">ZZZ</span><span class="p">.</span><span class="nx">API_TODO</span><span class="p">.</span><span class="nx">MESSAGE_WABA_TEMPLATE_CAN_ONLY_EDIT_ONCE_IN_24_HOURS</span><span class="p">.</span>
        <span class="nf">CallerSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span>   <span class="c1">// correct the stacktrace by 1 frame
</span><span class="c1"></span>        <span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>When all the migration is done, the previous usage:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">wabaErr</span> <span class="o">:=</span> <span class="nf">verifyWabaTemplateStatus</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>
<span class="nx">apiErr</span> <span class="o">:=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">FailPreconditionf</span><span class="p">(</span><span class="nx">wabaErr</span><span class="p">,</span> <span class="s">&#34;template cannot be edited&#34;</span><span class="p">).</span>
    <span class="nf">WithErrorCode</span><span class="p">(</span><span class="nx">ERROR_CODE_MESSAGE_WABA_TEMPLATE_CAN_ONLY_EDIT_ONCE_IN_24_HOURS</span><span class="p">).</span>    
    <span class="nf">WithUserMsg</span><span class="p">(</span><span class="s">&#34;According to WhatsApp, the message template can be only edited once in 24 hours. Consider creating a new message template instead.&#34;</span><span class="p">).</span>
    <span class="nf">ErrorOrNil</span><span class="p">()</span>
</code></pre></div><p>should become:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">CPG</span><span class="p">.</span><span class="nx">TPL</span><span class="p">.</span><span class="nx">EDIT_ONCE_IN_24_HOURS</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span>
    <span class="nx">wabaErr</span><span class="p">,</span> <span class="s">&#34;template cannot be edited&#34;</span><span class="p">,</span>
    <span class="nx">api</span><span class="p">.</span><span class="nf">UserMsg</span><span class="p">(</span><span class="s">&#34;According to WhatsApp, the message template can be only edited once in 24 hours. Consider creating a new message template instead.&#34;</span><span class="p">))</span>
</code></pre></div><p>Notice that the <code>ErrorCode</code> is implicitly derived from the internal namespace code. No need to explicitly assign it every time. But how to declare the relationship between codes? It will be explained in the next section.</p><h3 id="declaring-new-error-codes">Declaring new error codes</h3><p>At this point, you already know how to create new errors from existing codes. It&rsquo;s time to explain about codes and how to add a new one.</p><p><strong>A <code>Code</code> is implemented as an <code>uint16</code> value, which has a corresponding string presentation.</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Code</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">code</span><span class="p">:</span> <span class="kt">uint16</span> <span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%q&#34;</span><span class="p">,</span> <span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">)</span>
<span class="c1">// &#34;DEPS.PG.NOT_FOUND&#34;
</span></code></pre></div><p>To store those strings, there is an array of all available <code>CodeDesc</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">MaxCode</span> <span class="p">=</span> <span class="mi">321</span> <span class="c1">// 👈 this value is generated
</span><span class="c1"></span><span class="kd">var</span>   <span class="nx">allCodes</span> <span class="p">[</span><span class="nx">MaxCode</span><span class="p">]</span><span class="nx">CodeDesc</span>

<span class="kd">type</span> <span class="nx">CodeDesc</span> <span class="p">{</span>
    <span class="nx">c</span>    <span class="kt">int</span>     <span class="c1">// 42
</span><span class="c1"></span>    <span class="nx">code</span> <span class="kt">string</span>  <span class="c1">// DEPS.PG.NOT_FOUND
</span><span class="c1"></span>    <span class="nx">api</span> <span class="nx">APICodeDesc</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">APICodeDesc</span> <span class="p">{</span>
    <span class="nx">ErrorType</span>   <span class="nx">errorpb</span><span class="p">.</span><span class="nx">ErrorType</span>
    <span class="nx">ErrorCode</span>   <span class="nx">errorpb</span><span class="p">.</span><span class="nx">ErrorCode</span>
    <span class="nx">HttpCode</span>    <span class="kt">int</span>
    <span class="nx">DefMessage</span>  <span class="kt">string</span>
    <span class="nx">UserMessage</span> <span class="kt">string</span>
    <span class="nx">UserTitle</span>   <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p><strong>Here&rsquo;s how codes are declared:</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">DEPS</span> <span class="nx">deps</span>  <span class="c1">// dependencies
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">PRFL</span> <span class="nx">prfl</span>  <span class="c1">// profile
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">FLD</span>  <span class="nx">fld</span>   <span class="c1">// flow document
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">deps</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">PG</span> <span class="nx">pg</span>      <span class="c1">// postgres
</span><span class="c1"></span>    <span class="nx">RD</span> <span class="nx">rd</span>      <span class="c1">// redis
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// tag:postgres
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">pg</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">NOT_FOUND</span>   <span class="nx">Code0</span> <span class="c1">// record not found
</span><span class="c1"></span>    <span class="nx">CONFLICT</span>    <span class="nx">Code0</span> <span class="c1">// record already exist
</span><span class="c1"></span>    <span class="nx">MALFORM_SQL</span> <span class="nx">Code0</span>
<span class="p">}</span>
<span class="c1">// tag:profile
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PRFL</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">REPO</span> <span class="nx">prfl_repo</span>
    <span class="nx">USR</span>  <span class="nx">usr</span>
    <span class="nx">AUTH</span> <span class="nx">auth</span>
<span class="p">}</span>
<span class="c1">// tag:profile
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">prfl_repo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">NOT_FOUND</span>        <span class="nx">Code0</span>  <span class="c1">// internal error code
</span><span class="c1"></span>    <span class="nx">INVALID_ARGUMENT</span> <span class="nx">VlCode</span> <span class="c1">// internal error code
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// tag:usr
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">usr</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">NOT_FOUND</span>        <span class="nx">Code0</span>  <span class="s">`api-code:&#34;USER_NOT_FOUND&#34;`</span>
    <span class="nx">INVALID_ARGUMENT</span> <span class="nx">VlCode</span> <span class="s">`api-code:&#34;INVALID_ARGUMENT&#34;`</span>
    <span class="nx">DISABlED_ACCOUNT</span> <span class="nx">Code0</span>  <span class="s">`api-code:&#34;DISABLED_ACCOUNT&#34;`</span>
<span class="p">}</span>
<span class="c1">// tag:auth
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">auth</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">UNAUTHENTICATED</span>   <span class="nx">Code0</span> <span class="s">`api-code:&#34;UNAUTHENTICATED&#34;`</span>
    <span class="nx">PERMISSION_DENIED</span> <span class="nx">Code0</span> <span class="s">`api-code:&#34;PERMISSION_DENIED&#34;`</span>
<span class="p">}</span>
</code></pre></div><p>After declaring new codes, you need to <a href="https://olivernguyen.io/w/direnv.run">run</a> the generation script:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">run</span> <span class="nx">gen</span><span class="o">-</span><span class="nx">errors</span>
</code></pre></div><p>The generated code will look like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by error-codes. DO NOT EDIT.
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">UNAUTHENTICATED</span> <span class="p">=</span> <span class="nx">Code0</span><span class="p">{</span><span class="nx">Code</span><span class="p">{</span><span class="nx">code</span><span class="p">:</span> <span class="mi">143</span><span class="p">}}</span>  
    <span class="nx">PRFL</span><span class="p">.</span><span class="nx">AUTH</span><span class="p">.</span><span class="nx">PERMISSION_DENIED</span> <span class="p">=</span> <span class="nx">Code0</span><span class="p">{</span><span class="nx">Code</span><span class="p">{</span><span class="nx">code</span><span class="p">:</span> <span class="mi">144</span><span class="p">}}</span>
    
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">allCodes</span><span class="p">[</span><span class="mi">143</span><span class="p">]</span> <span class="p">=</span> <span class="nx">CodeDesc</span><span class="p">{</span>
        <span class="nx">c</span><span class="p">:</span> <span class="mi">143</span><span class="p">,</span> <span class="nx">code</span><span class="p">:</span> <span class="s">&#34;PRFL.AUTH.UNAUTHENTICATED&#34;</span><span class="p">,</span>
        <span class="nx">tags</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;auth&#34;</span><span class="p">,</span> <span class="s">&#34;profile&#34;</span><span class="p">},</span>  
        <span class="nx">api</span><span class="p">:</span> <span class="nx">APICodeDesc</span><span class="p">{</span>  
          <span class="nx">ErrorType</span><span class="p">:</span>      <span class="nx">ERROR_TYPE_UNAUTHENTICATED</span><span class="p">,</span>  
          <span class="nx">ErrorCode</span><span class="p">:</span>      <span class="nx">ERROR_CODE_UNAUTHENTICATED</span><span class="p">,</span>              
          <span class="nx">HTTPCode</span><span class="p">:</span>       <span class="mi">401</span><span class="p">,</span>  
          <span class="nx">DefMessage</span><span class="p">:</span>     <span class="s">&#34;Unauthenticated error&#34;</span><span class="p">,</span>        
          <span class="nx">UserMessage</span><span class="p">:</span>    <span class="s">&#34;You are not authenticated.&#34;</span><span class="p">,</span>   
          <span class="nx">UserTitle</span><span class="p">:</span>      <span class="s">&#34;Unauthenticated error&#34;</span><span class="p">,</span>        
       <span class="p">}))</span>
<span class="p">}</span>
</code></pre></div><p><strong>Each <code>Error</code> type has a corresponding <code>Code</code> type</strong></p><p>Ever wonder how <code>PRFL.USR.NOT_FOUND.New()</code> creates an <code>*Error0</code> while <code>PRFL.USR.INVALID_ARGUMENTS.New()</code> creates an <code>*VlError</code>? It&rsquo;s because they use different code types.</p><p>And each <code>Code</code> type returns different <code>Error</code> type, each can have its own extra methods:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Code0</span>  <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Code</span> <span class="p">}</span>
<span class="kd">type</span> <span class="nx">VlCode</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Code</span> <span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Code0</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Error0</span><span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">VlCode</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">VlError</span><span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// extra methods on VlCode to create VlBuilder
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">VlCode</span><span class="p">)</span> <span class="nf">WithMsg</span><span class="p">(</span><span class="nx">msg</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="nx">any</span><span class="p">)</span> <span class="o">*</span><span class="nx">VlBuilder</span> <span class="p">{</span><span class="cm">/*...*/</span><span class="p">}</span>    

<span class="kd">type</span> <span class="nx">VlBuilder</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">code</span> <span class="nx">VlCode</span>
    <span class="nx">msg</span>  <span class="kt">string</span>
    <span class="nx">args</span> <span class="p">[]</span><span class="nx">any</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">VlBuilder</span><span class="p">)</span> <span class="nf">ToError</span><span class="p">(</span><span class="cm">/*...*/</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">VlError</span><span class="p">{</span><span class="nx">Code</span><span class="p">:</span> <span class="nx">code</span><span class="p">,</span> <span class="cm">/*...*/</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><strong>Use <code>api-code</code> to mark the codes available for external API</strong></p><ul><li>The namespace error code should be used internally.</li><li>To make a code available for returning in external HTTP API, you need to mark it with <code>api-code</code>. The value is the corresponding <code>errorpb.ErrorCode</code>.</li><li>If an error code is not marked with <code>api-code</code>, it&rsquo;s internal code and will be shown as a generic <code>Internal Server Error</code>.</li><li>Notice that <code>PRFL.USR.NOT_FOUND</code> is external code, while <code>PRFL.USR.REPO.NOT_FOUND</code> is internal code.</li></ul><p><strong>Declare mapping between <code>ErrorCode</code>, <code>ErrorType</code>, and gRPC/HTTP codes in protobuf using enum option:</strong></p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="c1">// error/type.proto
</span><span class="c1"></span><span class="n">ERROR_TYPE_PERMISSION_DENIED</span> <span class="o">=</span> <span class="mi">707</span> <span class="p">[(</span><span class="n">error_type_detail_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>  <span class="err">
</span><span class="err"></span>    <span class="n">type</span><span class="o">:</span> <span class="s">&#34;PermissionDeniedError&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">grpc_code</span><span class="o">:</span> <span class="n">PERMISSION_DENIED</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">http_code</span><span class="o">:</span> <span class="mi">403</span><span class="p">,</span>  <span class="c1">// Forbidden  
</span><span class="c1"></span>    <span class="n">message</span><span class="o">:</span> <span class="s">&#34;permission denied&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">user_title</span><span class="o">:</span> <span class="s">&#34;Permission denied&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">user_message</span><span class="o">:</span> <span class="s">&#34;The caller does not have permission to execute the specified operation.&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span><span class="p">}];</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// error/code.proto
</span><span class="c1"></span><span class="n">ERROR_CODE_DISABlED_ACCOUNT</span> <span class="o">=</span> <span class="mi">70020</span> <span class="p">[(</span><span class="n">error_code_detail_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="n">error_type</span><span class="o">:</span> <span class="n">ERROR_TYPE_DISABlED_ACCOUNT</span><span class="p">,</span><span class="err">
</span><span class="err"></span>    <span class="n">grpc_code</span><span class="o">:</span> <span class="n">PERMISSION_DENIED</span><span class="p">,</span><span class="err">
</span><span class="err"></span>    <span class="n">http_code</span><span class="o">:</span> <span class="mi">403</span><span class="p">,</span>  <span class="c1">// Forbidden
</span><span class="c1"></span>    <span class="n">message</span><span class="o">:</span> <span class="s">&#34;account is disabled&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">user_title</span><span class="o">:</span> <span class="s">&#34;Account is disabled&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span>    <span class="n">user_message</span><span class="o">:</span> <span class="s">&#34;Your account is disabled. Please contact support for more information.&#34;</span><span class="p">,</span>  <span class="err">
</span><span class="err"></span><span class="p">}];</span><span class="err">
</span></code></pre></div><p><strong><code>UNEXPECTED</code> and <code>UNKNOWN</code> codes</strong></p><p>Each layer usually has 2 generic codes <code>UNEXPECTED</code> and <code>UNKNOWN</code>. They serve slightly different purposes:</p><ul><li><code>UNEXPECTED</code> code is used for errors that should never happen.</li><li><code>UNKNOWN</code> code is used for errors that are not explicitly handled.</li></ul><h3 id="mapping-errors-to-new-code">Mapping errors to new code</h3><p>When receiving an error returned from a function, you need to handle it: convert third-party errors to internal namespace errors and map error codes from inner layers to outer layers.</p><p><strong>Convert third-party errors to internal namespace errors</strong></p><p>How you handle errors depends on: what the third-party package returns and what your application needs. For example, when handling database or external API errors:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">switch</span> <span class="p">{</span>
<span class="k">case</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">ErrNoRows</span><span class="p">):</span>
    <span class="c1">// map a database &#34;no rows&#34; error to an internal &#34;not found&#34; error   
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">)</span>

<span class="k">case</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">):</span>
    <span class="c1">// map a context deadline exceeded error to a timeout error
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">TIMEOUT</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;query timeout&#34;</span><span class="p">)</span>

<span class="k">default</span><span class="p">:</span>
    <span class="c1">// wrap any other error as unknown
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;unexpected error&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>Using helpers for internal namespace errors</strong></p><ul><li><code>IsErrorCode(err, CODES...)</code>: Checks if the error contains any of the specified codes.</li><li><code>IsErrorGroup(err, GROUP)</code>: Return true if the error belongs to the input group.</li></ul><p>Typical usage pattern:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">queryUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">userReq</span><span class="p">)</span>
<span class="k">switch</span> <span class="p">{</span>
<span class="k">case</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
    <span class="c1">// continue
</span><span class="c1"></span>
<span class="k">case</span> <span class="nf">IsErrorCode</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">):</span>    
    <span class="c1">// check for specific error code and convert to external code
</span><span class="c1"></span>    <span class="c1">// and return as HTTP 400 Not Found
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">)</span>

<span class="k">case</span> <span class="nf">IsGroup</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">):</span>
    <span class="c1">// errors belong to the PRFL.USR group are returned as is
</span><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>

<span class="k">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to query user&#34;</span><span class="p">)</span>   
<span class="p">}</span>
</code></pre></div><p><strong><code>MapError()</code> for writing mapping code easier:</strong></p><p>Since mapping error codes is a common pattern, there is a <code>MapError()</code> helper to make writing code faster. The above code can be rewritten as:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">queryUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">userReq</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">MapError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span>
        <span class="nf">Map</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> <span class="s">&#34;user not found&#34;</span><span class="p">).</span>    
        <span class="nf">KeepGroup</span><span class="p">(</span><span class="nx">PRF</span><span class="p">.</span><span class="nx">USR</span><span class="p">).</span>
        <span class="nf">Default</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">,</span> <span class="s">&#34;failed to query user&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>You can format arguments and add key/value pairs as usual:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">MapError</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span>
    <span class="nf">Map</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">REPO</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> <span class="nx">PRFL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">,</span> 
        <span class="s">&#34;user %v not found&#34;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> 
        <span class="nx">l</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">)).</span>    
    <span class="nf">KeepGroup</span><span class="p">(</span><span class="nx">PRF</span><span class="p">.</span><span class="nx">USR</span><span class="p">).</span>
    <span class="nf">Default</span><span class="p">(</span><span class="nx">PRL</span><span class="p">.</span><span class="nx">USR</span><span class="p">.</span><span class="nx">UNKNOWN</span><span class="p">,</span> <span class="s">&#34;failed to query user&#34;</span><span class="p">,</span> 
        <span class="nx">l</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="s">&#34;retries&#34;</span><span class="p">,</span> <span class="nx">retryCount</span><span class="p">))</span>
</code></pre></div><h3 id="testing-with-namespace-errors">Testing with namespace <code>Error</code>s</h3><p>Testing is critical for any serious code base. The framework provides specialized helpers like <code>ΩxError()</code> to make writing and asserting error conditions in tests easier and more expressive.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 👉 return true if the error contains the message
</span><span class="c1"></span><span class="nx">ΩxError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Contains</span><span class="p">(</span><span class="s">&#34;not found&#34;</span><span class="p">)</span>

<span class="c1">// 👉 return true if the error does not contain the message
</span><span class="c1"></span><span class="nx">ΩxError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">NOT</span><span class="p">().</span><span class="nf">Contains</span><span class="p">(</span><span class="s">&#34;not found&#34;</span><span class="p">)</span>
</code></pre></div><p>There are many more methods, and you can chain them too:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ΩxError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span>
    <span class="nf">MatchCode</span><span class="p">(</span><span class="nx">DEPS</span><span class="p">.</span><span class="nx">PG</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">).</span>  <span class="c1">// match any code in top or wrapped errors
</span><span class="c1"></span>    <span class="nf">TopErrorMatchCode</span><span class="p">(</span><span class="nx">PRFL</span><span class="p">.</span><span class="nx">TPL</span><span class="p">.</span><span class="nx">NOT_FOUND</span><span class="p">)</span> <span class="c1">// only match code from the top error
</span><span class="c1"></span>    <span class="nf">MatchAPICode</span><span class="p">(</span><span class="nx">API_CODE</span><span class="p">.</span><span class="nx">WABA_TEMPLATE_NOTE_FOUND</span><span class="p">).</span> <span class="c1">// match errorpb.ErrorCode
</span><span class="c1"></span>    <span class="nf">MatchExact</span><span class="p">(</span><span class="s">&#34;exact message to match&#34;</span><span class="p">)</span>
</code></pre></div><p><strong>Why use methods instead of <code>Ω(err).To(testing.MatchCode())</code>?</strong></p><p>Because methods are more discoverable. When you&rsquo;re faced with dozens of functions like <code>testing.MatchValues()</code>, it&rsquo;s hard to know which ones will work with <code>Error</code>s and which will not. With methods, you can simply type a dot <code>.</code>, and your IDE will list all available methods specifically designed for asserting <code>Error</code>s.</p><hr><h2 id="migration">Migration</h2><p>The framework is just half of the story. Writing the code? That’s the easy part. The real challenge starts when you have to bring it into a massive, living codebase where dozens of engineers are pushing changes daily, customers expect everything to work perfectly, and the system just can’t stop running.</p><p>Migration comes with responsibility. It’s about carefully splitting <del>hair</del> tiny bits of code, making tiny changes at a time, breaking a ton of tests in the process. Then manually inspecting and fixing them one by one, merging into the main branch, deploying to production, watching the logs and alerts. Repeating it over and over&hellip;</p><p>Here are some tips for migration that we learned along the way:</p><p><strong>Start with search and replace:</strong> Begin by replacing old patterns with the new framework. Fix any compilation issues that arise from this process.</p><p>For example, replace all <code>error</code> in this package with <code>Error</code>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ProfileController</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">LoginUser</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">LoginRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">LoginResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">QueryUser</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">QueryUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">QueryUserResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>The new code will look like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">.</span> <span class="s">&#34;connectly.ai/go/pkgs/errors&#34;</span>

<span class="kd">type</span> <span class="nx">ProfileController</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">LoginUser</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">LoginRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">LoginResponse</span><span class="p">,</span> <span class="nx">Error</span><span class="p">)</span>
    <span class="nf">QueryUser</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">QueryUserRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">QueryUserResponse</span><span class="p">,</span> <span class="nx">Error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>Migrate one package at a time:</strong> Start with the lowest-level packages and work your way up. This way, you can ensure that the lower-level packages are fully migrated before moving on to the higher-level ones.</p><p><strong>Add missing unit tests:</strong> If parts of the codebase lack tests, add them. If you are not confident in your changes, add more tests. They are helpful to make sure that your changes don’t break existing functionality.</p><p><strong>If your package depends on calling higher-level packages:</strong> Consider changing the related functions to DEPRECATED then add new functions with the new <code>Error</code> type.</p><p>Assume that you are migrating the database package, which has the <code>Transaction()</code> method:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">database</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Transaction</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> 
    <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">gorm</span><span class="p">.</span><span class="nf">Transaction</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><p>And it is used in the user service package:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">DB</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Transaction</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">database</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">user</span><span class="p">,</span> <span class="nx">usrErr</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">repo</span><span class="p">.</span><span class="nf">CreateUser</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">usrErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">usrErr</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Since you are migrating the <code>database</code> package first, leaving the <code>user</code> and dozens of other packages as it. The <code>s.repo.CreateUser()</code> call still returns the old <code>error</code> type while the <code>Transaction()</code> method needs to return the new <code>Error</code> type. You can change the <code>Transaction()</code> method to <code>DEPRECATED</code> and add a new <code>TransactionV2()</code> method:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">database</span>

<span class="c1">// DEPRECATED: use TransactionV2 instead
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Transaction_DEPRECATED</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> 
    <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">gorm</span><span class="p">.</span><span class="nf">Transaction</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">TransactionV2</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> 
    <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="nx">Error</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">gorm</span><span class="p">.</span><span class="nf">Transaction</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nf">adaptToErrorV2</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>Add new error codes as you go</strong>: When you encounter an error that doesn’t fit into the existing ones, add a new code. This will help you build a comprehensive set of error codes over time. Codes from other packages are always available as references.</p><hr><h2 id="conclusion">Conclusion</h2><p>Error handling in Go can feel simple at first—just return an <code>error</code> and move on. But as our codebase grew, that simplicity turned into a tangled mess of vague logs, inconsistent handling, and endless debugging sessions.</p><p>By stepping back and rethinking how we handle errors, we’ve built a system that works for us, not against us. Centralized and structured namespace codes give us clarity, while tools for mapping, wrapping, and testing errors make our lives easier. Instead of swimming through sea of logs, we now have meaningful, traceable errors that tell us what’s wrong and where to look.</p><p>This framework isn’t just about making our code cleaner; it’s about saving time, reducing frustration, and helping us prepare for the unknown. It&rsquo;s just the beginning of a journey — we are still discovering more patterns — but the result is a system that can somehow bring peace of mind to error handling. Hopefully, it can spark some ideas for your projects too! 😊</p><hr><h3 id="subscribe">Let's stay connected!</h3><div>If you like the post, subscribe to <a href="https://olivernguyen.substack.com/">my newsletter</a> to get latest updates:</div><div id="subscription-form"><iframe src="https://olivernguyen.substack.com/embed" width="100%" height="160" style="border:1px solid #eee;border-radius:4px;box-shadow:1px 1px 2px 0 #eee;background:0 0" frameborder="0" scrolling="no"></iframe></div><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>or <a href="https://olivernguyen.substack.com">subscribe to my posts</a>.</span></p></div></article><div id="header-post"><div class="menu-icons"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="header-toc"><nav id="TableOfContents"><ul><li><a href="#go-errors-are-just-values">Go errors are just values</a></li><li><a href="#every-package-needs-to-deal-with-errors">Every package needs to deal with errors</a></li><li><a href="#we-started-with-a-common-approach">We started with a common approach</a></li><li><a href="#and-problems-grew-over-time">And problems grew over time</a></li><li><a href="#its-time-to-centralize-error-handling">It&rsquo;s time to centralize error handling</a><ul><li><a href="#back-to-the-drawing-board">Back to the drawing board</a></li><li><a href="#design-decisions">Design decisions</a></li></ul></li><li><a href="#the-namespace-error-framework">The namespace error framework</a><ul><li><a href="#core-packages-and-types">Core packages and types</a></li><li><a href="#example-usage">Example usage</a></li><li><a href="#creating-and-wrapping-errors">Creating and wrapping errors</a></li><li><a href="#adding-context-to-errors">Adding context to errors</a></li><li><a href="#different-types-error0-vlerror-apierror">Different types: <code>Error0</code>, <code>VlError</code>, <code>ApiError</code></a></li><li><a href="#declaring-new-error-codes">Declaring new error codes</a></li><li><a href="#mapping-errors-to-new-code">Mapping errors to new code</a></li><li><a href="#testing-with-namespace-errors">Testing with namespace <code>Error</code>s</a></li></ul></li><li><a href="#migration">Migration</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script></script><div class="toc-header"><a href="#">Errors, Errors Everywhere: How We Centralized and Structured Error Handling</a></div><nav id="TableOfContents"><ul><li><a href="#go-errors-are-just-values">Go errors are just values</a></li><li><a href="#every-package-needs-to-deal-with-errors">Every package needs to deal with errors</a></li><li><a href="#we-started-with-a-common-approach">We started with a common approach</a></li><li><a href="#and-problems-grew-over-time">And problems grew over time</a></li><li><a href="#its-time-to-centralize-error-handling">It&rsquo;s time to centralize error handling</a><ul><li><a href="#back-to-the-drawing-board">Back to the drawing board</a></li><li><a href="#design-decisions">Design decisions</a></li></ul></li><li><a href="#the-namespace-error-framework">The namespace error framework</a><ul><li><a href="#core-packages-and-types">Core packages and types</a></li><li><a href="#example-usage">Example usage</a></li><li><a href="#creating-and-wrapping-errors">Creating and wrapping errors</a></li><li><a href="#adding-context-to-errors">Adding context to errors</a></li><li><a href="#different-types-error0-vlerror-apierror">Different types: <code>Error0</code>, <code>VlError</code>, <code>ApiError</code></a></li><li><a href="#declaring-new-error-codes">Declaring new error codes</a></li><li><a href="#mapping-errors-to-new-code">Mapping errors to new code</a></li><li><a href="#testing-with-namespace-errors">Testing with namespace <code>Error</code>s</a></li></ul></li><li><a href="#migration">Migration</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fnamespace.error%2f&title=Errors%2c%20Errors%20Everywhere%3a%20How%20We%20Centralized%20and%20Structured%20Error%20Handling"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fnamespace.error%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fnamespace.error%2f&text=Errors%2c%20Errors%20Everywhere%3a%20How%20We%20Centralized%20and%20Structured%20Error%20Handling"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fnamespace.error%2f&title=Errors%2c%20Errors%20Everywhere%3a%20How%20We%20Centralized%20and%20Structured%20Error%20Handling"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fnamespace.error%2f&t=Errors%2c%20Errors%20Everywhere%3a%20How%20We%20Centralized%20and%20Structured%20Error%20Handling"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2025 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><div class="body-right"></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>