<!doctype html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>The power of diff in testing - Part 1: SQL queries and mocks | Oliver Nguyen</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="all,follow"><meta name="googlebot" content="index,follow,snippet,archive"><meta name="og:site_name" content="Oliver Nguyen"><meta property="og:title" content="The power of diff in testing - Part 1: SQL queries and mocks"><meta property="og:description" content="A new day at work Suppose that you, a good software engineer, just got hired by an e-commerce business. And you are joining a team to work on the profile service to manage customers and their addresses.
There are a Customer and an Address struct, with a couple of gorm tags for the database schema:
type Customer struct { ID uuid.UUID `gorm:&#34;type:uuid;primaryKey&#34; json:&#34;id&#34;` Name string `json:&#34;name&#34;` Age int `json:&#34;age&#34;` Gender string `json:&#34;gender&#34;` Email string `gorm:&#34;uniqueIndex&#34; json:&#34;email&#34;` Phone string `json:&#34;phone&#34;` Occupation string `json:&#34;occupation&#34;` Addresses []Address `gorm:&#34;foreignKey:CustomerID&#34; json:&#34;addresses&#34;` Languages []string `gorm:&#34;type:text[]&#34; json:&#34;languages&#34;` } type Address struct { ID uuid."><meta property="og:type" content="article"><meta property="og:url" content="https://iOliverNguyen.github.io/w/diff.testing/"><meta property="og:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta property="article:section" content="w"><meta property="article:published_time" content="2024-12-26T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-26T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://iOliverNguyen.github.io/images/ogx.png"><meta name="twitter:title" content="The power of diff in testing - Part 1: SQL queries and mocks"><meta name="twitter:description" content="A new day at work Suppose that you, a good software engineer, just got hired by an e-commerce business. And you are joining a team to work on the profile service to manage customers and their addresses.
There are a Customer and an Address struct, with a couple of gorm tags for the database schema:
type Customer struct { ID uuid.UUID `gorm:&#34;type:uuid;primaryKey&#34; json:&#34;id&#34;` Name string `json:&#34;name&#34;` Age int `json:&#34;age&#34;` Gender string `json:&#34;gender&#34;` Email string `gorm:&#34;uniqueIndex&#34; json:&#34;email&#34;` Phone string `json:&#34;phone&#34;` Occupation string `json:&#34;occupation&#34;` Addresses []Address `gorm:&#34;foreignKey:CustomerID&#34; json:&#34;addresses&#34;` Languages []string `gorm:&#34;type:text[]&#34; json:&#34;languages&#34;` } type Address struct { ID uuid."><link rel="stylesheet" href="https://iOliverNguyen.github.io/css/style-classic.css"><link rel="stylesheet" href="https://iOliverNguyen.github.io/style.css"><link rel="icon" type="image/png" href="/images/favicon.png"><link href="https://iOliverNguyen.github.io/w/diff.testing/index.xml" rel="alternate" type="application/rss+xml" title="Oliver Nguyen"><script async src="https://www.googletagmanager.com/gtag/js?id=G-L5X8RJDCLM"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-L5X8RJDCLM")</script><script src="/script.js"></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">The power of diff in testing - Part 1: SQL queries and mocks</h1><div class="meta"><div class="postdate"><time datetime="2024-12-26 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-12-26</time></div><div class="article-tag">&nbsp;·&nbsp; <a class="tag-link" href="/w/#go" rel="tag">go</a></div>&nbsp;·&nbsp;&nbsp;<a href="#subscribe">subscribe to my posts</a></div></header><div class="content" itemprop="articleBody"><h2 id="a-new-day-at-work">A new day at work</h2><p>Suppose that you, a good software engineer, just got hired by an e-commerce business. And you are joining a team to work on the profile service to manage customers and their addresses.</p><p>There are a <code>Customer</code> and an <code>Address</code> struct, with a couple of <code>gorm</code> tags for the database schema:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Customer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>         <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;type:uuid;primaryKey&#34; json:&#34;id&#34;`</span>
    <span class="nx">Name</span>       <span class="kt">string</span>    <span class="s">`json:&#34;name&#34;`</span>
    <span class="nx">Age</span>        <span class="kt">int</span>       <span class="s">`json:&#34;age&#34;`</span>
    <span class="nx">Gender</span>     <span class="kt">string</span>    <span class="s">`json:&#34;gender&#34;`</span>
    <span class="nx">Email</span>      <span class="kt">string</span>    <span class="s">`gorm:&#34;uniqueIndex&#34; json:&#34;email&#34;`</span>
    <span class="nx">Phone</span>      <span class="kt">string</span>    <span class="s">`json:&#34;phone&#34;`</span>
    <span class="nx">Occupation</span> <span class="kt">string</span>    <span class="s">`json:&#34;occupation&#34;`</span>
    <span class="nx">Addresses</span>  <span class="p">[]</span><span class="nx">Address</span> <span class="s">`gorm:&#34;foreignKey:CustomerID&#34; json:&#34;addresses&#34;`</span>
    <span class="nx">Languages</span>  <span class="p">[]</span><span class="kt">string</span>  <span class="s">`gorm:&#34;type:text[]&#34; json:&#34;languages&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Address</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>          <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;type:uuid;primaryKey&#34; json:&#34;id&#34;`</span>
    <span class="nx">CustomerID</span>  <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;type:uuid;not null;index&#34; json:&#34;customer_id&#34;`</span>
    <span class="nx">HouseNumber</span> <span class="kt">int</span>       <span class="s">`json:&#34;house_number&#34;`</span>
    <span class="nx">Street</span>      <span class="kt">string</span>    <span class="s">`json:&#34;street&#34;`</span>
    <span class="nx">City</span>        <span class="kt">string</span>    <span class="s">`json:&#34;city&#34;`</span>
    <span class="nx">Country</span>     <span class="kt">string</span>    <span class="s">`json:&#34;country&#34;`</span>
    <span class="nx">ZipCode</span>     <span class="kt">string</span>    <span class="s">`json:&#34;zip_code&#34;`</span>
<span class="p">}</span>
</code></pre></div><p>You look at the method <code>UpdateCustomerWithAddress()</code> which to update a customer and their associated addresses:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ProfileRepository</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewProfileRepository</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="o">*</span><span class="nx">ProfileRepository</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ProfileRepository</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span> <span class="nx">db</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// UpdateCustomerWithAddress updates a customer and their associated addresses
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">ProfileRepository</span><span class="p">)</span> <span class="nf">UpdateCustomerWithAddress</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">customer</span> <span class="o">*</span><span class="nx">Customer</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tx</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Begin</span><span class="p">()</span> <span class="c1">// start a transaction
</span><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="p">}()</span>

    <span class="c1">// upsert customer
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Clauses</span><span class="p">(</span>
        <span class="nx">clause</span><span class="p">.</span><span class="nx">OnConflict</span><span class="p">{</span>
            <span class="nx">Columns</span><span class="p">:</span>   <span class="p">[]</span><span class="nx">clause</span><span class="p">.</span><span class="nx">Column</span><span class="p">{{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;id&#34;</span><span class="p">}},</span> <span class="c1">// Use the primary key column
</span><span class="c1"></span>            <span class="nx">DoUpdates</span><span class="p">:</span> <span class="nx">clause</span><span class="p">.</span><span class="nf">AssignmentColumns</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">,</span> <span class="s">&#34;gender&#34;</span><span class="p">,</span> <span class="s">&#34;email&#34;</span><span class="p">,</span> <span class="s">&#34;phone&#34;</span><span class="p">,</span> <span class="s">&#34;occupation&#34;</span><span class="p">,</span> <span class="s">&#34;languages&#34;</span><span class="p">}),</span>
        <span class="p">},</span>
    <span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">customer</span><span class="p">).</span><span class="nx">Error</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="c1">// upsert addresses
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Clauses</span><span class="p">(</span>
            <span class="nx">clause</span><span class="p">.</span><span class="nx">OnConflict</span><span class="p">{</span>
                <span class="nx">Columns</span><span class="p">:</span>   <span class="p">[]</span><span class="nx">clause</span><span class="p">.</span><span class="nx">Column</span><span class="p">{{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;id&#34;</span><span class="p">}},</span>
                <span class="nx">DoUpdates</span><span class="p">:</span> <span class="nx">clause</span><span class="p">.</span><span class="nf">AssignmentColumns</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;house_number&#34;</span><span class="p">,</span> <span class="s">&#34;street&#34;</span><span class="p">,</span> <span class="s">&#34;city&#34;</span><span class="p">,</span> <span class="s">&#34;country&#34;</span><span class="p">,</span> <span class="s">&#34;zip_code&#34;</span><span class="p">}),</span>
            <span class="p">},</span>
        <span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">).</span><span class="nx">Error</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">().</span><span class="nx">Error</span> <span class="c1">// commit the transaction
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>So far so good. It looks like a typical method to update a customer and their addresses, uses <code>gorm</code> to interact with the database, and wraps the operation in a transaction.</p><p>Now you check the test for this method:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">customer</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>
    <span class="s">&#34;github.com/google/uuid&#34;</span>
    <span class="s">&#34;gorm.io/driver/postgres&#34;</span>
    <span class="s">&#34;gorm.io/gorm&#34;</span>

    <span class="p">.</span> <span class="s">&#34;ezpkg.io/conveyz&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">customerWithAddress</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">addrID1</span><span class="p">,</span> <span class="nx">addrID2</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span><span class="p">)</span> <span class="o">*</span><span class="nx">Customer</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Customer</span><span class="p">{</span>
        <span class="nx">ID</span><span class="p">:</span>         <span class="nx">id</span><span class="p">,</span>
        <span class="nx">Name</span><span class="p">:</span>       <span class="s">&#34;Alice Nguyen&#34;</span><span class="p">,</span>
        <span class="nx">Age</span><span class="p">:</span>        <span class="mi">22</span><span class="p">,</span>
        <span class="nx">Gender</span><span class="p">:</span>     <span class="s">&#34;female&#34;</span><span class="p">,</span>
        <span class="nx">Email</span><span class="p">:</span>      <span class="s">&#34;alice@example.com&#34;</span><span class="p">,</span>
        <span class="nx">Phone</span><span class="p">:</span>      <span class="s">&#34;(+84) 123-456-789&#34;</span><span class="p">,</span>
        <span class="nx">Occupation</span><span class="p">:</span> <span class="s">&#34;Software Engineer&#34;</span><span class="p">,</span>
        <span class="nx">Languages</span><span class="p">:</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;English&#34;</span><span class="p">,</span> <span class="s">&#34;Vietnamese&#34;</span><span class="p">,</span> <span class="s">&#34;Japanese&#34;</span><span class="p">},</span>
        <span class="nx">Addresses</span><span class="p">:</span> <span class="p">[]</span><span class="nx">Address</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ID</span><span class="p">:</span>          <span class="nx">addrID1</span><span class="p">,</span>
                <span class="nx">HouseNumber</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
                <span class="nx">Street</span><span class="p">:</span>      <span class="s">&#34;Ly Thuong Kiet&#34;</span><span class="p">,</span>
                <span class="nx">City</span><span class="p">:</span>        <span class="s">&#34;Ha Noi&#34;</span><span class="p">,</span>
                <span class="nx">Country</span><span class="p">:</span>     <span class="s">&#34;Vietnam&#34;</span><span class="p">,</span>
                <span class="nx">ZipCode</span><span class="p">:</span>     <span class="s">&#34;101010&#34;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nx">ID</span><span class="p">:</span>          <span class="nx">addrID2</span><span class="p">,</span>
                <span class="nx">HouseNumber</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
                <span class="nx">Street</span><span class="p">:</span>      <span class="s">&#34;Vo Van Kiet&#34;</span><span class="p">,</span>
                <span class="nx">City</span><span class="p">:</span>        <span class="s">&#34;Ho Chi Minh City&#34;</span><span class="p">,</span>
                <span class="nx">Country</span><span class="p">:</span>     <span class="s">&#34;Vietnam&#34;</span><span class="p">,</span>
                <span class="nx">ZipCode</span><span class="p">:</span>     <span class="s">&#34;210120&#34;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestProfile</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;Test Profile&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
        <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>

        <span class="nx">gormDB</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">postgres</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">postgres</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">db</span><span class="p">}))</span>
        <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>

        <span class="nx">profileRepo</span> <span class="o">:=</span> <span class="nf">NewProfileRepository</span><span class="p">(</span><span class="nx">gormDB</span><span class="p">)</span>

        <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;Customer&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;UpdateCustomerWithAddress&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nf">Convey</span><span class="p">(</span><span class="s">&#34;both customer + address changes&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nx">customerID</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
                    <span class="nx">addrID1</span><span class="p">,</span> <span class="nx">addrID2</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">(),</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
                    <span class="nx">customer</span> <span class="o">:=</span> <span class="nf">customerWithAddress</span><span class="p">(</span><span class="nx">customerID</span><span class="p">,</span> <span class="nx">addrID1</span><span class="p">,</span> <span class="nx">addrID2</span><span class="p">)</span>

                    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
                    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">`INSERT INTO &#34;customers&#34; \(&#34;id&#34;,&#34;name&#34;,&#34;age&#34;,&#34;gender&#34;,&#34;email&#34;,&#34;phone&#34;,&#34;occupation&#34;,&#34;languages&#34;\) VALUES \(\$1,\$2,\$3,\$4,\$5,\$6,\$7,\(\$8,\$9,\$10\)\) ON CONFLICT \(&#34;id&#34;\) DO UPDATE SET &#34;name&#34;=&#34;excluded&#34;.&#34;name&#34;,&#34;age&#34;=&#34;excluded&#34;.&#34;age&#34;,&#34;gender&#34;=&#34;excluded&#34;.&#34;gender&#34;,&#34;email&#34;=&#34;excluded&#34;.&#34;email&#34;,&#34;phone&#34;=&#34;excluded&#34;.&#34;phone&#34;,&#34;occupation&#34;=&#34;excluded&#34;.&#34;occupation&#34;,&#34;languages&#34;=&#34;excluded&#34;.&#34;languages&#34;`</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span>
                        <span class="nx">customerID</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Age</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Gender</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Email</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Phone</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Occupation</span><span class="p">,</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Languages</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Languages</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Languages</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="nx">addr0</span><span class="p">,</span> <span class="nx">addr1</span> <span class="o">:=</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">`INSERT INTO &#34;addresses&#34; \(&#34;id&#34;,&#34;customer_id&#34;,&#34;house_number&#34;,&#34;street&#34;,&#34;city&#34;,&#34;country&#34;,&#34;zip_code&#34;\) VALUES \(\$1,\$2,\$3,\$4,\$5,\$6,\$7\),\(\$8,\$9,\$10,\$11,\$12,\$13,\$14\) ON CONFLICT \(&#34;id&#34;\) DO UPDATE SET &#34;customer_id&#34;=&#34;excluded&#34;.&#34;customer_id&#34;`</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span>
                        <span class="nx">addr0</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
                        <span class="nx">addr1</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
                    <span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">`INSERT INTO &#34;addresses&#34; \(&#34;id&#34;,&#34;customer_id&#34;,&#34;house_number&#34;,&#34;street&#34;,&#34;city&#34;,&#34;country&#34;,&#34;zip_code&#34;\) VALUES \(\$1,\$2,\$3,\$4,\$5,\$6,\$7\),\(\$8,\$9,\$10,\$11,\$12,\$13,\$14\) ON CONFLICT \(&#34;id&#34;\) DO UPDATE SET &#34;house_number&#34;=&#34;excluded&#34;.&#34;house_number&#34;,&#34;street&#34;=&#34;excluded&#34;.&#34;street&#34;,&#34;city&#34;=&#34;excluded&#34;.&#34;city&#34;,&#34;country&#34;=&#34;excluded&#34;.&#34;country&#34;,&#34;zip_code&#34;=&#34;excluded&#34;.&#34;zip_code&#34;`</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span>
                        <span class="nx">addr0</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
                        <span class="nx">addr1</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
                    <span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

                    <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectCommit</span><span class="p">()</span>

                    <span class="nx">err</span> <span class="p">=</span> <span class="nx">profileRepo</span><span class="p">.</span><span class="nf">UpdateCustomerWithAddress</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">customer</span><span class="p">)</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                    <span class="nx">err</span> <span class="p">=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">()</span>
                    <span class="nx">Ω</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">ToNot</span><span class="p">(</span><span class="nf">HaveOccurred</span><span class="p">())</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div><p>So, the test is written with <a href="https://ezpkg.io/conveyz">ezpkg.io/conveyz</a>, which is a fancy combination of <a href="https://github.com/smartystreets/goconvey">smartystreets/convey</a> and <a href="https://github.com/onsi/gomega">onsi/gomega</a>. It uses <a href="https://github.com/DATA-DOG/go-sqlmock">go-sqlmock</a> to mock the database and assert the SQL queries. It seems like a lot of boilerplate code to write and maintain. But at least it works. And by looking at the tests, we know what the actual SQL queries are.</p><p>Okay, your onboarding task is to add a couple of new fields to the <code>Address</code> struct: <code>Phone</code> and <code>Receiver</code>. Because your boss told you, when using our delivery service, a customer may want to deliver to her husband or her friend, with different phone numbers.</p><p>It&rsquo;s just a simple change – you tell yourself. You add these new fields to the <code>Address</code> struct, and the <code>UpdateCustomerWithAddress()</code> method should be able to handle it automatically with the magic of <code>gorm</code>.</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Address</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>          <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;type:uuid;primaryKey&#34; json:&#34;id&#34;`</span>
    <span class="nx">CustomerID</span>  <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;type:uuid;not null;index&#34; json:&#34;customer_id&#34;`</span>
    <span class="nx">Phone</span>       <span class="kt">string</span>    <span class="s">`json:&#34;phone&#34;`</span>        <span class="c1">// 👈 one here
</span><span class="c1"></span>    <span class="nx">Receiver</span>    <span class="kt">string</span>    <span class="s">`json:&#34;receiver&#34;`</span>     <span class="c1">//    and here
</span><span class="c1"></span>    <span class="nx">HouseNumber</span> <span class="kt">int</span>       <span class="s">`json:&#34;house_number&#34;`</span>
    <span class="nx">Street</span>      <span class="kt">string</span>    <span class="s">`json:&#34;street&#34;`</span>
    <span class="nx">City</span>        <span class="kt">string</span>    <span class="s">`json:&#34;city&#34;`</span>
    <span class="nx">Country</span>     <span class="kt">string</span>    <span class="s">`json:&#34;country&#34;`</span>
    <span class="nx">ZipCode</span>     <span class="kt">string</span>    <span class="s">`json:&#34;zip_code&#34;`</span>
<span class="p">}</span>
</code></pre></div><p>You start all services on local, send a couple of HTTP requests with the new fields, and everything works fine: database schema is updated, data is saved, and retrieved correctly. You are confident that the changes are good to go.</p><p>Now, before sending a pull request, you need to update the tests to cover the new fields. It should be a simple fix, and the tests will work again, right?</p><p><img src="a1.png" alt=""></p><p>Ugh, you look at the error message and quickly get lost in the SQL queries. You know that you need to update the SQL queries to include the new fields, but it&rsquo;s hard to figure out where to put the changes. You try to update the queries many times, but the tests keep failing. You are frustrated and starting to doubt your changes.</p><p>Okay, at last, maybe you can copy the SQL queries from the error message and paste them into the test. But it&rsquo;s not a good practice. You just overrode the previous queries with the new queries. Who knows if your new queries are always correct? How to compare the new queries with the previous queries? And what if the queries change in the future? You need to update the tests again and again. It&rsquo;s a nightmare!</p><h2 id="finding-a-better-way-to-test-sql-queries">Finding a better way to test SQL queries</h2><p>It&rsquo;s time to find a better way to test the SQL queries. Instead of the messy regexp matching, you need a tool that can compare the actual queries with the expected queries, and show you the differences, so you can quickly identify what&rsquo;s wrong.</p><p>Luckily, <code>go-sqlmock</code> has <a href="https://pkg.go.dev/github.com/DATA-DOG/go-sqlmock#QueryMatcherOption"><code>QueryMatcherOption</code></a> to allow you to define a custom matcher for the SQL queries. You can use this feature to compare the actual queries with the expected queries, and show the differences in a human-readable format.</p><p>Let&rsquo;s create a new package <code>sqlmockz</code>:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">sqlmockz</span>

<span class="kn">import</span> <span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>

<span class="kd">var</span> <span class="nx">OptionDiffMatcher</span> <span class="p">=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">diffMatcherImpl</span><span class="p">{})</span>

<span class="kd">type</span> <span class="nx">diffMatcherImpl</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">diffMatcherImpl</span><span class="p">)</span> <span class="nf">Match</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">,</span> <span class="nx">expectedSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// 👉 return an error if the actual SQL is different from the expected SQL
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>And the usage will be like this:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">sqlmockz</span><span class="p">.</span><span class="nx">OptionDiffMatcher</span><span class="p">)</span>
</code></pre></div><h2 id="implementing-the-diff-matcher">Implementing the diff matcher</h2><p>The package <a href="https://ezpkg.io/diffz">ezpkg.io/diffz</a> provides some useful functions to compare the differences between two strings. Two notable functions are <a href="https://pkg.go.dev/ezpkg.io/diffz#ByChar"><code>diffz.ByChar()</code></a> and <a href="https://pkg.go.dev/ezpkg.io/diffz#ByLine"><code>diffz.ByLine()</code></a>. Under the hook, it uses <a href="sergi/go-diff">https://github.com/sergi/go-diff</a> and <a href="https://github.com/kylelemons/godebug">kylelemons/godebug</a> to calculate the diffs.</p><p>In our case of comparing SQL queries, the <code>ByChar()</code> function is more suitable, because it can show the added columns. While in case of comparing JSON or YAML in API response, the <code>ByLine()</code> function serves better.</p><p>Now, it&rsquo;s time to implement the <code>Match()</code> method in the <code>diffMatcherImpl</code> struct:</p><ul><li>Use <code>diffz.ByChar()</code> to compare the actual SQL with the expected SQL.</li><li>If the actual SQL is different from the expected SQL, print the actual SQL, the expected SQL, and the differences.</li><li>Use <a href="https://ezpkg.io/colorz"><code>colorz</code></a> to colorize the output for better readability.</li></ul><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">sqlmockz</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>

    <span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>

    <span class="s">&#34;ezpkg.io/colorz&#34;</span>
    <span class="s">&#34;ezpkg.io/diffz&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">OptionDiffMatcher</span> <span class="p">=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">diffMatcherImpl</span><span class="p">{})</span>

<span class="kd">type</span> <span class="nx">diffMatcherImpl</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">diffMatcherImpl</span><span class="p">)</span> <span class="nf">Match</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">,</span> <span class="nx">expectedSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">diffs</span> <span class="o">:=</span> <span class="nx">diffz</span><span class="p">.</span><span class="nf">ByChar</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">,</span> <span class="nx">expectedSQL</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">diffs</span><span class="p">.</span><span class="nf">IsDiff</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\n%v\n%v\n&#34;</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Red</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="s">&#34;--- ActualSQL ---&#34;</span><span class="p">),</span> <span class="nx">actualSQL</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\n%v\n%v\n&#34;</span><span class="p">,</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Green</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="s">&#34;--- ExpectedSQL ---&#34;</span><span class="p">),</span> <span class="nx">expectedSQL</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\n--- Diff (%v%v) ---\n%v\n&#34;</span><span class="p">,</span>
        <span class="nx">colorz</span><span class="p">.</span><span class="nx">Red</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="s">&#34;actual&#34;</span><span class="p">),</span> <span class="nx">colorz</span><span class="p">.</span><span class="nx">Green</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">),</span>
        <span class="nx">diffz</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">diffs</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;actual SQL does not equal to expected&#34;</span><span class="p">)</span>
<span class="p">}</span>    
</code></pre></div><p>You can now use the <code>OptionDiffMatcher</code> in sqlmock:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">sqlmockz</span><span class="p">.</span><span class="nx">OptionDiffMatcher</span><span class="p">)</span>
</code></pre></div><p>And the error message will show exactly what&rsquo;s need to be changed:</p><p><img src="a2.png" alt=""></p><p>The actual SQL is missing the <code>phone</code> and <code>receiver</code> columns. You can quickly identify the problem, confirm that the change is correct, then update the test accordingly!</p><h2 id="making-it-even-better-by-ignoring-spaces">Making it even better by ignoring spaces</h2><p>But you still need to carefully put the spaces correctly in the SQL queries:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">addr0</span><span class="p">,</span> <span class="nx">addr1</span> <span class="o">:=</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">`INSERT INTO &#34;addresses&#34; (&#34;id&#34;,&#34;customer_id&#34;,&#34;house_number&#34;,&#34;street&#34;,&#34;city&#34;,&#34;country&#34;,&#34;zip_code&#34;) VALUES ($1,$2,$3,$4,$5,$6,$7),($8,$9,$10,$11,$12,$13,$14) ON CONFLICT (&#34;id&#34;) DO UPDATE SET &#34;customer_id&#34;=&#34;excluded&#34;.&#34;customer_id&#34;`</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span>
    <span class="nx">addr0</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
    <span class="nx">addr1</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
<span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div><p>It should be better to ignore the spaces when comparing the SQL queries, so you can freely format the SQL queries in a more readable way:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">addr0</span><span class="p">,</span> <span class="nx">addr1</span> <span class="o">:=</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">customer</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">`
</span><span class="s">    INSERT INTO &#34;addresses&#34; (
</span><span class="s">        &#34;id&#34;,&#34;customer_id&#34;,&#34;house_number&#34;,&#34;street&#34;,&#34;city&#34;,&#34;country&#34;,&#34;zip_code&#34;,
</span><span class="s">    ) VALUES ($1,$2,$3,$4,$5,$6,$7),($8,$9,$10,$11,$12,$13,$14) 
</span><span class="s">    ON CONFLICT (&#34;id&#34;) DO UPDATE SET &#34;customer_id&#34;=&#34;excluded&#34;.&#34;customer_id&#34;`</span>
<span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span>
    <span class="nx">addr0</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr0</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
    <span class="nx">addr1</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">customerID</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">HouseNumber</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Street</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">City</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">Country</span><span class="p">,</span> <span class="nx">addr1</span><span class="p">.</span><span class="nx">ZipCode</span><span class="p">,</span>
<span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div><p>Yes, there is a sister function <a href="https://pkg.go.dev/ezpkg.io/diffz#ByCharZ"><code>diffz.ByCharZ()</code></a> to ignore the spaces when comparing the SQL queries. Just put it in the <code>Match()</code> method and you are good to go:</p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">diffs</span> <span class="o">:=</span> <span class="nx">diffz</span><span class="p">.</span><span class="nf">ByCharZ</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">,</span> <span class="nx">expectedSQL</span><span class="p">)</span>
</code></pre></div><h2 id="conclusion">Conclusion</h2><p>By a simple change to the matcher with <a href="https://pkg.go.dev/ezpkg.io/diffz#ByCharZ"><code>diffz.ByCharZ()</code></a>, you can confidently make changes and update the tests. When there is any change in the SQL queries, the error message will show you exactly what&rsquo;s need to be updated.</p><p>Instead of spending hours struggling with the messy regexp matching, you can now focus on the actual important bit and grab a nice cup of coffee.</p><p>Enjoy coding! 🚀</p><hr><h3 id="subscribe">Let's stay connected!</h3><div>If you like the post, subscribe to <a href="https://olivernguyen.substack.com/">my newsletter</a> to get latest updates:</div><div id="subscription-form"><iframe src="https://olivernguyen.substack.com/embed" width="100%" height="160" style="border:1px solid #eee;border-radius:4px;box-shadow:1px 1px 2px 0 #eee;background:0 0" frameborder="0" scrolling="no"></iframe></div><h2 id="author">Author</h2><p>I'm Oliver Nguyen. A software maker working mostly in Go and JavaScript. I enjoy learning and seeing a better version of myself each day. Occasionally spin off new open source projects. Share knowledge and thoughts during my journey. <span>Connect with me on <a class="icon" target="_blank" rel="noopener" href="https://github.com/iOliverNguyen"><i class="fab fa-github"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://linkedin.com/in/iOliverNguyen"><i class="fab fa-linkedin"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://x.com/_OliverNguyen"><i class="fab fa-twitter"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="https://iOliverNguyen.medium.com"><i class="fab fa-medium-m"></i> </a>, <a class="icon" target="_blank" rel="noopener" href="mailto:iOliverNguyen@gmail.com"><i class="fas fa-envelope"></i> </a>or <a href="https://olivernguyen.substack.com">subscribe to my posts</a>.</span></p></div></article><div id="header-post"><div class="menu-icons"><a id="menu-icon" href="/w"><i class="fas fa-chevron-left fa-lg"></i> <span class="icon-text">Back</span></a></div><div id="header-toc"><nav id="TableOfContents"><ul><li><a href="#a-new-day-at-work">A new day at work</a></li><li><a href="#finding-a-better-way-to-test-sql-queries">Finding a better way to test SQL queries</a></li><li><a href="#implementing-the-diff-matcher">Implementing the diff matcher</a></li><li><a href="#making-it-even-better-by-ignoring-spaces">Making it even better by ignoring spaces</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" class="tog-footer" style="display:none"><script></script><div class="toc-header"><a href="#">The power of diff in testing - Part 1: SQL queries and mocks</a></div><nav id="TableOfContents"><ul><li><a href="#a-new-day-at-work">A new day at work</a></li><li><a href="#finding-a-better-way-to-test-sql-queries">Finding a better way to test SQL queries</a></li><li><a href="#implementing-the-diff-matcher">Implementing the diff matcher</a></li><li><a href="#making-it-even-better-by-ignoring-spaces">Making it even better by ignoring spaces</a></li><li><a href="#conclusion">Conclusion</a></li></ul></nav></div><div id="share-footer" class="tog-footer" style="display:none"><ul><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdiff.testing%2f&title=The%20power%20of%20diff%20in%20testing%20-%20Part%201%3a%20SQL%20queries%20and%20mocks"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdiff.testing%2f"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://x.com/share?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdiff.testing%2f&text=The%20power%20of%20diff%20in%20testing%20-%20Part%201%3a%20SQL%20queries%20and%20mocks"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdiff.testing%2f&title=The%20power%20of%20diff%20in%20testing%20-%20Part%201%3a%20SQL%20queries%20and%20mocks"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fiOliverNguyen.github.io%2fw%2fdiff.testing%2f&t=The%20power%20of%20diff%20in%20testing%20-%20Part%201%3a%20SQL%20queries%20and%20mocks"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="home" class="icon" href="/w"><i class="fas fa-chevron-left fa-lg" aria-hidden="true"></i> Back</a> <a id="toc" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $(".tog-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2025 Oliver Nguyen.</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><div class="body-right"></div></body><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/js/main.js"></script></html>